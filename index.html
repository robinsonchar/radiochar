<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RADIOCHAR - Hits 80s/90s</title>
  
  <!-- 1. Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  
  <!-- 2. Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Fuentes: Shrikhand, Poppins y Russo One -->
  <link href="https://fonts.googleapis.com/css2?family=Shrikhand&family=Poppins:wght@300;400;600;700;800;900&family=Russo+One&display=swap" rel="stylesheet">

  <style>
    /* --- RESET Y BASE --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      background: #0f0f0f;
      color: #fff;
      overflow-x: hidden;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      padding-bottom: 80px; /* Espacio extra al final */
    }

    /* --- FONDO AMBIENTAL --- */
    .background-blur {
      position: fixed; top: -10%; left: -10%; width: 120%; height: 120%;
      z-index: -1;
      background-image: url('https://bit.ly/4q9Jddl');
      background-size: cover; background-position: center;
      filter: blur(50px) brightness(0.3);
      will-change: opacity, background-image;
      transition: background-image 1s ease-in-out;
    }

    /* --- TRANSICIONES --- */
    .visual-transition { transition: opacity 0.8s ease-in-out; opacity: 1; }
    .visual-transition.fading-out { opacity: 0; }

    /* --- NUEVOS ESTILOS META INFO (LIVE & LISTENERS) DENTRO DEL PLAYER --- */
    .player-meta-row {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 8px; /* Espacio antes del título */
        width: 100%;
        justify-content: flex-start; /* Alineado a la izquierda */
    }

    .live-tag-inline {
        display: flex;
        align-items: center;
        gap: 6px;
        color: #fff;
        font-size: 11px;
        font-weight: 800;
        letter-spacing: 1px;
    }

    .live-dot-inline {
        width: 8px; 
        height: 8px; 
        border-radius: 50%; 
        background-color: #ff0000;
        box-shadow: 0 0 8px rgba(255, 0, 0, 0.8);
        animation: blink 1.5s infinite;
    }

    .listener-tag-inline {
        display: flex; 
        align-items: center; 
        gap: 5px;
        font-size: 11px; 
        font-weight: 600;
        color: #888; /* Color sutil */
    }
    
    .listener-tag-inline i { font-size: 10px; color: #aaa; }

    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* --- LOGOTIPO (IMAGEN) - REDUCIDO --- */
    .radio-logo {
      display: block;
      max-width: 400px; 
      width: 80%;
      height: auto;
      margin-top: 60px;
      margin-bottom: 40px;
      z-index: 5;
      padding: 0 10px; 
      box-sizing: border-box;
      filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.1)); 
    }

    /* --- PANTALLA DE CARGA --- */
    .splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #0f0f0f;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 100;
      animation: fadeOut 1s 3s forwards; pointer-events: none;
    }
    .spinner { border: 3px solid #333; border-top: 3px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

    /* --- CONTENEDOR REPRODUCTOR --- */
    .radio-container {
      display: flex;
      width: 1000px; max-width: 95%; height: 320px;
      background: rgba(30, 30, 30, 0.6);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      box-shadow: 0 30px 70px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.05);
      margin-top: 20px; 
      margin-bottom: 100px; 
      flex-shrink: 0;
    }

    .cover { flex: 0 0 320px; position: relative; overflow: hidden; }
    .cover img { width: 100%; height: 100%; object-fit: cover; display: block; transition: transform 0.5s ease; }
    .album-year-badge { position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.7); color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 10; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); }
    .wiki-btn { position: absolute; top: 15px; right: 15px; width: 32px; height: 32px; background: rgba(0, 0, 0, 0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.9); text-decoration: none; transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.2); z-index: 20; backdrop-filter: blur(5px); font-size: 14px; cursor: pointer; }
    .wiki-btn:hover { background: rgba(255, 255, 255, 0.9); color: #000; transform: scale(1.1); border-color: #fff; }
    .player { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; padding: 30px 40px; position: relative; }
    #winampVis { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 0.1; }
    .info-wrapper { z-index: 5; text-align: left; margin-bottom: 25px; width: 100%; overflow: hidden; }
    .song-title-container { width: 100%; white-space: nowrap; overflow: hidden; }
    .song-title-container.is-scrolling { mask-image: linear-gradient(to right, black 90%, transparent 100%); -webkit-mask-image: linear-gradient(to right, black 90%, transparent 100%); }
    .song-title { font-size: 45px; font-weight: 700; color: #fff; display: inline-block; margin-bottom: 5px; padding-right: 20px; }
    .artist-name { font-size: 18px; color: #aaa; font-weight: 400; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .scrolling-text { animation: scroll-text 15s linear infinite alternate; }
    @keyframes scroll-text { 0%, 15% { transform: translateX(0); } 85%, 100% { transform: translateX(var(--scroll-distance)); } }
    .timeline-container { width: 100%; display: flex; align-items: center; gap: 15px; margin-bottom: 25px; z-index: 5; }
    .time-display { font-size: 12px; font-weight: 600; color: #ddd; font-variant-numeric: tabular-nums; min-width: 40px; }
    .progress-bar-bg { flex: 1; min-width: 0; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; position: relative; }
    .progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #00c6ff, #0072ff); border-radius: 3px; transition: width 1s linear; }
    .controls-row { display: flex; align-items: center; justify-content: center; z-index: 5; width: 100%; }
    .play-btn-wrapper { position: relative; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; }
    .play-btn { width: 60px; height: 60px; border-radius: 50%; background: #fff; border: none; color: #121212; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(255,255,255,0.3); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); padding-left: 4px; }
    .play-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(255,255,255,0.5); }
    .play-btn.playing { padding-left: 0; background: #00c6ff; color: #fff; }

    /* =========================================
       NUEVA SECCIÓN: SLOGAN (Russo One)
       ========================================= */
    .slogan-section {
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
        margin-top: 70px; 
        margin-bottom: 70px;
        text-align: center;
        z-index: 5;
    }
    
    .slogan-text {
        font-family: 'Russo One', sans-serif;
        font-size: 60px; 
        color: #fff;
        text-transform: uppercase; 
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); 
        letter-spacing: 2px;
        line-height: 1.1;
        margin-bottom: 10px; 
    }

    .sub-slogan {
        font-family: 'Russo One', sans-serif;
        font-size: 30px;
        color: #fff;
        text-transform: uppercase;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        letter-spacing: 2px;
        margin-top: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

    .live-badge-red {
        background-color: #ff0000;
        color: white;
        font-size: 14px;
        padding: 4px 12px;
        border-radius: 4px;
        font-weight: 700;
        letter-spacing: 1px;
        animation: blink-red 1.5s infinite;
        vertical-align: middle;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.6);
    }

    @keyframes blink-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* =========================================
       SECCIÓN: COMUNIDAD (FACEBOOK)
       ========================================= */
    .community-section {
        width: 100%;
        max-width: 1000px;
        margin-top: 50px;
        margin-bottom: 50px; 
        text-align: center;
        z-index: 5;
    }

    .community-title {
        font-family: 'Russo One', sans-serif;
        font-size: 60px;
        color: #fff;
        text-transform: uppercase;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.1); 
        margin-bottom: 25px;
        letter-spacing: 1px;
        line-height: 1.1;
    }

    .buttons-container {
        display: flex;
        justify-content: center;
        gap: 20px; 
        flex-wrap: wrap; 
    }

    .btn-social {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-family: 'Poppins', sans-serif;
        font-size: 20px;
        font-weight: 700;
        padding: 15px 40px;
        border-radius: 50px;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        min-width: 250px; 
    }

    .btn-facebook {
        background-color: #1877F2; 
        color: #fff;
        box-shadow: 0 4px 15px rgba(24, 119, 242, 0.4);
    }

    .btn-facebook:hover {
        background-color: #1565C0; 
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(24, 119, 242, 0.6);
    }

    .btn-social i { margin-right: 12px; font-size: 24px; }


    /* =========================================
       CLASES COMUNES DE ENCABEZADO
       ========================================= */
    .section-header-common {
        margin-bottom: 30px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
    }
    
    .section-title-common {
        font-size: 18px; 
        text-transform: uppercase; 
        letter-spacing: 2px;
        font-weight: 700;
        padding-left: 10px;
        margin: 0;
    }

    /* =========================================
       SECCIÓN HISTORIAL (Simple)
       ========================================= */
    .recent-tracks-container {
      width: 1000px; max-width: 95%;
      margin-bottom: 50px;
      z-index: 5;
    }
    
    /* Título AZUL */
    .recent-tracks-title-custom {
        color: #00c6ff; /* Azul */
        border-left: 3px solid #00c6ff;
    }

    .recent-tracks-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; }
    
    .hist-card { background: rgba(30, 30, 30, 0.4); border-radius: 10px; overflow: hidden; position: relative; transition: transform 0.3s ease; }
    .hist-card:hover { transform: translateY(-3px); }
    .hist-cover-wrap { position: relative; width: 100%; aspect-ratio: 1/1; }
    .hist-cover { width: 100%; height: 100%; object-fit: cover; }
    .hist-num { position: absolute; top: 8px; right: 8px; width: 26px; height: 26px; background: rgba(0,0,0,0.8); color: #fff; border-radius: 50%; font-size: 12px; font-weight: 700; display: flex; align-items: center; justify-content: center; border: 0px solid #00c6ff; z-index: 2; }
    .hist-info { padding: 10px; }
    .hist-title { font-size: 12px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
    .hist-artist { font-size: 11px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* NUEVO: ESTILO PARA EL TIEMPO TRANSCURRIDO */
    .hist-time {
        font-size: 10px;
        color: #00c6ff; 
        margin-top: 4px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
        opacity: 0.9;
    }
    .hist-time i { font-size: 9px; }

    .no-tracks-msg { color: #666; font-style: italic; }

    /* =========================================
       SECCIÓN TOP 5 BILLBOARD 1985 (Diseño Ajustado)
       ========================================= */
    .top-hits-container {
      width: 1000px; max-width: 95%;
      margin-top: 50px;
      margin-bottom: 50px;
      z-index: 5;
    }

    /* Título AMARILLO */
    .top-hits-title-custom {
        color: #ffd700; /* Amarillo Dorado */
        border-left: 3px solid #ffd700;
    }
    
    .top-hits-date { display: none; }

    .billboard-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 25px; 
      align-items: stretch;
    }

    /* IZQUIERDA: #1 Hit */
    .hit-number-one {
      background: rgba(30, 30, 30, 0.3);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.05); 
      display: flex;
      flex-direction: column;
    }

    .hit-one-cover {
      width: 100%; 
      aspect-ratio: 1/1; 
      object-fit: cover;
      display: block;
    }

    /* Número 1 Gigante y Dorado superpuesto */
    .hit-one-rank-overlay {
      position: absolute; top: 10px; left: 10px;
      font-size: 60px; font-weight: 900;
      color: #ffd700; 
      text-shadow: 3px 3px 0 rgba(0,0,0,0.8);
      z-index: 10;
      line-height: 0.8;
      font-style: italic;
    }

    .hit-one-info {
      padding: 15px;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      position: absolute;
      bottom: 0; left: 0; width: 100%;
    }

    .hit-one-title { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .hit-one-artist { font-size: 14px; color: #ccc; }

    /* DERECHA: Lista #2 - #5 */
    .hits-list {
      display: flex;
      flex-direction: column;
      gap: 15px; 
      justify-content: space-between;
    }

    .hit-card {
      display: flex;
      align-items: center;
      background: rgba(30, 30, 30, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 12px;
      transition: all 0.2s ease;
      flex: 1;
    }

    .hit-card:hover {
      background: rgba(255,255,255,0.08);
      transform: translateX(5px);
    }

    /* Número Grande a la Izquierda */
    .hit-rank-large {
      font-size: 36px; 
      font-weight: 900; 
      color: rgba(255, 255, 255, 0.3);
      width: 50px; 
      text-align: center;
      margin-right: 10px;
      line-height: 1;
      font-style: italic;
    }
    
    .rank-2 { color: rgba(255, 255, 255, 0.7); } 
    .rank-3 { color: rgba(255, 255, 255, 0.5); }

    .hit-small-cover {
      width: 55px; height: 55px;
      border-radius: 6px;
      margin-right: 15px;
      object-fit: cover;
      background: #111;
      display: block;
    }

    .hit-info { flex: 1; min-width: 0; }
    .hit-title { font-size: 18px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #eee; }
    .hit-artist { font-size: 14px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }


    /* =========================================
       NUEVA SECCIÓN: ¿SABÍAS QUE?
       ========================================= */
    .did-you-know-container {
      width: 1000px; max-width: 95%;
      margin-top: 50px; 
      margin-bottom: 50px;
      z-index: 5;
    }
    
    /* Título FUCSIA */
    .dyk-title-custom {
        color: #ff00de; /* Fucsia */
        border-left: 3px solid #ff00de;
    }

    /* ESTILO LIMPIO Y SUTIL PARA EL CONTENEDOR */
    .dyk-card {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 30px; 
      background: rgba(74, 74, 74, 0.1); 
      border: none; 
      border-radius: 16px;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .dyk-cover-wrapper {
      width: 100%;
      height: 320px; 
      position: relative;
    }

    .dyk-cover {
      width: 100%; height: 100%; object-fit: cover; display: block;
      border-radius: 12px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
    }
    
    .dyk-badge {
      position: absolute; top: 15px; left: 15px;
      background: #ff00de; color: #fff;
      font-weight: 700; font-size: 12px;
      padding: 4px 12px; border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      text-transform: uppercase; letter-spacing: 1px;
      border: 1px solid #ff00de;
    }

    .dyk-content {
      padding: 10px 30px 10px 0; /* AJUSTE: MÁS PADDING A LA DERECHA */
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .dyk-song-title {
      font-size: 28px; font-weight: 800; color: #fff;
      margin-bottom: 5px; line-height: 1.2;
    }
    
    .dyk-song-artist {
      font-size: 18px; color: #00c6ff; font-weight: 600;
      margin-bottom: 20px;
    }

    .dyk-meta {
      display: flex; gap: 20px; margin-bottom: 25px;
      font-size: 13px; color: #aaa; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;
    }
    .dyk-meta div i { margin-right: 5px; color: #ccc; }

    /* ESTILO LIMPIO PARA EL TEXTO DE RESEÑA */
    .dyk-text {
      font-size: 15px; 
      line-height: 1.7; 
      color: #ddd;
      font-style: normal; 
      background: transparent; 
      padding: 0; 
      border: none; 
    }
    
    /* =========================================
       NUEVA SECCIÓN: UN DÍA COMO HOY (1985)
       ========================================= */
    .news-section-container {
      width: 1000px; max-width: 95%;
      margin-top: 50px; 
      margin-bottom: 50px;
      z-index: 5;
    }
    
    /* Título VERDE NEÓN */
    .news-title-custom {
        color: #39ff14; 
        border-left: 3px solid #39ff14;
    }

    /* ESTILO LIMPIO: 2 COLUMNAS SIN BORDE */
    .news-card {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 30px; 
        background: rgba(74, 74, 74, 0.1); 
        border: none; 
        border-radius: 16px;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }
    
    .news-image-wrapper {
        width: 100%;
        height: 320px;
        overflow: hidden;
        position: relative;
    }
    
    .news-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    
    .news-card:hover .news-image {
        transform: scale(1.05);
    }
    
    .news-date-badge {
        position: absolute;
        top: 15px;
        left: 15px;
        background: #39ff14;
        color: #000;
        font-weight: 700;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        border: 1px solid #39ff14;
        z-index: 2;
    }
    
    .news-content {
        padding: 10px 30px 10px 0; /* AJUSTE: MÁS PADDING A LA DERECHA */
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .news-headline {
        font-size: 28px;
        font-weight: 800;
        color: #fff;
        margin-bottom: 15px;
        line-height: 1.2;
    }
    
    .news-body {
        font-size: 15px;
        line-height: 1.7;
        color: #ddd;
    }

    /* CSS para el Chat Flotante CBOX - REDONDEADO Y AZUL - AHORA SOLO ICONO */
    #cboxbutton {
      z-index: 2000 !important; 
      border-radius: 50% !important; /* Circular */
      background-color: #1877F2 !important; /* AZUL */
      border: 1px solid #1565C0 !important;
      color: #fff !important;
      width: 50px !important; /* Tamaño fijo */
      height: 50px !important;
      padding: 0 !important; /* Sin relleno de texto */
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3) !important;
      font-size: 20px !important;
    }
    #cboxwrap {
      z-index: 2000 !important; 
      border-radius: 12px !important; 
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      background: rgba(255, 255, 255, 0.8) !important; 
      backdrop-filter: blur(10px) !important;
    }
    #cboxdiv {
       width: 100% !important;
       max-width: 600px !important;
    }

    /* Ocultar el widget original de Centova */
    #cc_recenttracks_original { display: none !important; }

    /* --- RESPONSIVE --- */
    @media (max-width: 800px) {
      .billboard-layout, .dyk-card, .news-card { grid-template-columns: 1fr; }
      .hit-number-one { aspect-ratio: 16/9; min-height: 250px; }
      .hit-one-cover { aspect-ratio: 16/9; object-position: center 20%; }
      
      .dyk-cover-wrapper, .news-image-wrapper { height: 250px; }
      .dyk-cover, .news-image { object-position: center 20%; }
      
      /* AJUSTE: RESETEAR PADDING EN MOVIL PARA QUE NO QUEDE RARO */
      .dyk-content, .news-content { padding: 20px; }

      .slogan-text, .community-title { font-size: 36px; } 
      .sub-slogan { font-size: 24px; }
      
      .buttons-container { flex-direction: column; align-items: center; }
      .btn-social { width: 100%; max-width: 300px; }
    }

    @media (max-width: 600px) {
      .radio-container { flex-direction: column; height: auto; width: 90%; }
      .cover { flex: 0 0 300px; height: 300px; }
      .player { padding: 25px; align-items: center; text-align: center; }
      .info-wrapper { text-align: center; }
      .controls-row { justify-content: center; gap: 20px; }
      
      /* Alineación del meta en móvil también a la izquierda en desktop, pero quizás centrado en móvil? 
         Lo dejaremos a la izquierda por ahora para consistencia, o puedes agregar justify-content: center aquí si prefieres. */
      .player-meta-row { justify-content: center; } 

      .recent-tracks-grid { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); }
      .radio-container, .recent-tracks-container, .top-hits-container, .did-you-know-container, .slogan-section, .community-section, .news-section-container { margin-bottom: 50px; } 
      .radio-logo { max-width: 300px; } 
    }

    /* --- MODAL POPUP --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.4s ease; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal-content { background: #1a1a1a; width: 700px; max-width: 95%; padding: 30px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5); transform: translateY(20px); transition: transform 0.4s ease; position: relative; }
    .modal-overlay.active .modal-content { transform: translateY(0); }
    .modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; opacity: 0.6; transition: opacity 0.3s; }
    .modal-close:hover { opacity: 1; }
    .modal-title { font-size: 22px; font-weight: 700; margin-bottom: 10px; color: #fff; }
    .modal-subtitle { font-size: 14px; color: #00c6ff; margin-bottom: 20px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    .modal-body { font-size: 14px; line-height: 1.6; color: #ccc; max-height: 300px; overflow-y: auto; padding-right: 10px; }
    .modal-meta { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 20px; font-size: 13px; color: #888; }
    .modal-meta span { display: block; color: #fff; font-weight: 500; margin-top: 3px; }
    .creator-footer { margin-top: 10px; font-size: 12px; color: rgba(255, 255, 255, 0.4); text-align: center; z-index: 5; }
    .creator-footer a { color: #fff; text-decoration: none; opacity: 0.7; }
    .creator-footer a:hover { opacity: 1; text-decoration: underline; }
  </style>
</head>
<body>

<!-- Fondo Blur -->
<div class="background-blur visual-transition" id="bgBlur"></div>

<!-- Splash Screen -->
<div class="splash-screen">
  <h1>Sintonizando...</h1>
  <div class="spinner"></div>
</div>

<!-- Modal Pop-up -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
    <div class="modal-title" id="modalArtist">Artista</div>
    <div class="modal-subtitle" id="modalTitle">Canción</div>
    <div class="modal-body" id="modalBio">Cargando información...</div>
    <div class="modal-meta">
        <div>Álbum<span id="modalAlbum">--</span></div>
        <div>Género<span id="modalGenre">--</span></div>
    </div>
  </div>
</div>

<!-- Título / Logotipo -->
<!-- REEMPLAZADO POR IMAGEN -->
<img src="https://bit.ly/4rSMOON" alt="Radiochar" class="radio-logo">


<!-- REPRODUCTOR PRINCIPAL -->
<div class="radio-container">
  <!-- Lado Izquierdo: Portada -->
  <div class="cover">
    <div id="wikiBtn" class="wiki-btn" title="Ver reseña" onclick="openInfoModal()"><i class="fas fa-info"></i></div>
    <div id="albumYear" class="album-year-badge visual-transition"></div>
    <img id="albumArt" class="visual-transition" src="https://bit.ly/4q9Jddl" alt="Cover" />
  </div>

  <!-- Lado Derecho: Controles e Info -->
  <div class="player">
    <canvas id="winampVis"></canvas>
    <!-- Info Canción -->
    <div class="info-wrapper">
      
      <!-- NUEVA UBICACIÓN: INDICADORES LIVE Y OYENTES -->
      <div class="player-meta-row">
          <div class="live-tag-inline">
              <div class="live-dot-inline"></div>
              LIVE
          </div>
          <div class="listener-tag-inline">
              <i class="fas fa-headphones"></i>
              <span id="listenerCount">--</span>
          </div>
      </div>

      <div class="song-title-container">
        <div id="displayTitle" class="song-title visual-transition">Conectando...</div>
      </div>
      <div id="displayArtist" class="artist-name visual-transition">Radiochar</div>
    </div>
    <!-- Línea de Tiempo -->
    <div class="timeline-container">
      <div id="currentTime" class="time-display">00:00</div>
      <div class="progress-bar-bg"><div id="progressFill" class="progress-bar-fill"></div></div>
      <div id="totalTime" class="time-display">--:--</div>
    </div>
    <!-- Controles -->
    <div class="controls-row">
      <div class="play-btn-wrapper">
        <button id="playPause" class="play-btn"><i class="fas fa-play"></i></button>
      </div>
    </div>
    <!-- Data oculta del reproductor -->
    <div id="data-source" style="display: none;">
        <div id="trackTitleSource" class="cc_streaminfo" data-type="tracktitle" data-username="robinson"></div>
        <div id="trackArtistSource" class="cc_streaminfo" data-type="trackartist" data-username="robinson"></div>
    </div>
  </div>
</div>

<!-- SECCIÓN: HISTORIAL DE CANCIONES (Simple con número) - ARRIBA -->
<div class="recent-tracks-container">
    <!-- CLASE UNIFICADA: Encabezado -->
    <div class="section-header-common">
        <!-- CLASE UNIFICADA: Título AZUL -->
        <h2 class="section-title-common recent-tracks-title-custom">LAS ÚLTIMAS QUE SONARON</h2>
    </div>
    <div id="recentTracksGrid" class="recent-tracks-grid">
        <!-- JS llenará esto -->
        <div class="no-tracks-msg">Cargando historial...</div>
    </div>
</div>

<!-- SECCIÓN: SLOGAN (NUEVA SECCIÓN) -->
<div class="slogan-section">
    <h2 class="slogan-text">LA EMISORA ONLINE NÚMERO UNO EN LATAM</h2>
    <h3 class="sub-slogan">TRANSMITIENDO 24/7 DESDE 2011<span class="live-badge-red">LIVE</span></h3>
</div>

<!-- SECCIÓN: TOP 5 BILLBOARD (Diseño Ajustado con Números Grandes) - EN MEDIO -->
<div class="top-hits-container">
    <!-- CLASE UNIFICADA: Encabezado -->
    <div class="section-header-common">
        <!-- CLASE UNIFICADA: Título AMARILLO -->
        <h2 class="section-title-common top-hits-title-custom">TOP 5 DE AYER</h2>
        <div id="topHitsDateDisplay" class="top-hits-date">...</div>
    </div>
    
    <div class="billboard-layout" id="billboardContainer">
        <!-- JS llenará esto -->
    </div>
</div>

<!-- SECCIÓN: ¿SABÍAS QUE? (Diseño Limpio y Sutil) - ABAJO -->
<div class="did-you-know-container" id="didYouKnowContainer" style="display: none;">
    <!-- CLASE UNIFICADA: Encabezado -->
    <div class="section-header-common">
         <!-- CLASE UNIFICADA: Título FUCSIA -->
        <h2 class="section-title-common dyk-title-custom">SABÍAS QUE...</h2>
    </div>
    <div id="dykContent" class="dyk-card">
        <!-- Se llena dinámicamente -->
        <div class="dyk-cover-wrapper">
            <div class="dyk-badge">El Dato</div>
            <img src="" class="dyk-cover" id="dykCover" alt="Cover">
        </div>
        <div class="dyk-content">
            <div class="dyk-song-title" id="dykTitle">Cargando...</div>
            <div class="dyk-song-artist" id="dykArtist">...</div>
            <div class="dyk-meta">
                <div id="dykAlbum"><i class="fas fa-compact-disc"></i> <span>--</span></div>
                <div id="dykYear"><i class="fas fa-calendar-alt"></i> <span>--</span></div>
            </div>
            <div class="dyk-text" id="dykText">
                Buscando datos interesantes sobre esta canción...
            </div>
        </div>
    </div>
</div>

<!-- SECCIÓN: UN DÍA COMO HOY (1985) -->
<div class="news-section-container">
    <!-- CLASE UNIFICADA: Encabezado -->
    <div class="section-header-common">
         <!-- CLASE UNIFICADA: Título VERDE NEÓN -->
        <h2 class="section-title-common news-title-custom">UN DÍA COMO HOY DE 1985</h2>
    </div>
    
    <div class="news-card">
        <div class="news-image-wrapper">
             <div class="news-date-badge" id="newsDateBadge">--/--</div>
             <img src="" id="newsImage" class="news-image" alt="Noticia Musical" onerror="this.src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgLNh9EesljZjOf9Wd4kxbj_a-I04zgQmfpM1gcDbEF6PXkq7CtZ-71Kgc8TwALbpRGi3EDbTIjTEI1N5QRDDXqD6QhV3UHE79leufBWqZoAxys7KiIcviuxnB-ozdP15EVtEGONWR_ZeHPabjdfUd_X8FkdcoDCtVrNvolF3fQyA8N7eLEoozmI895tiEf/s16000/radiochar-vice.png'">
        </div>
        <div class="news-content">
            <h3 class="news-headline" id="newsHeadline">Cargando efemérides...</h3>
            <p class="news-body" id="newsBody">Estamos buscando en nuestros archivos de 1985...</p>
        </div>
    </div>
</div>

<!-- SECCIÓN: COMUNIDAD (SOLO FACEBOOK) - ABAJO FINAL -->
<div class="community-section">
    <h2 class="community-title">ÚNETE A NUESTRA COMUNIDAD</h2>
    <div class="buttons-container">
        <a href="https://www.facebook.com/Radionlineco/" target="_blank" class="btn-social btn-facebook">
            <i class="fab fa-facebook-f"></i> Síguenos en Facebook
        </a>
    </div>
</div>

<!-- CBOX BUTTON AND WRAPPER (INJECTED) -->
<div id="cboxbutton" style="position: fixed; bottom: 8px; right: 16px; padding: 3px 20px; text-align: center; cursor: pointer; background-color: #EDF3F7; border:#C3D7E5 1px solid;border-radius: 3px; font-family: Tahoma, sans-serif; font-size: 14px; font-weight: bold"></div>
<div id="cboxwrap" style="position: fixed; bottom: 48px; right: 16px; background: #EDF3F7; padding: 3px; border:#C3D7E5 1px solid;border-radius: 3px;"></div>

<div class="creator-footer">
  Powered by <a href="https://www.robinsonchar.online/" target="_blank">robinsonchar</a>
</div>

<!-- WIDGET ORIGINAL OCULTO -->
<div id="cc_recenttracks_original" class="cc_recenttracks_list" data-username="robinson"></div>

<!-- SCRIPTS -->
<audio id="radio" src="https://cast2.my-control-panel.com/proxy/robinson/stream" crossorigin="anonymous"></audio>
<script src="https://cast2.my-control-panel.com/system/streaminfo.js"></script>
<script src="https://cast2.my-control-panel.com/system/recenttracks.js"></script>

<script>
// SCROLL TO TOP ON RELOAD
if ('scrollRestoration' in history) {
    history.scrollRestoration = 'manual';
}
window.onload = function() {
    window.scrollTo(0, 0);
};

/*
*	Cbox dynamic loader v.2
*/
(function () {
	var showByDefault = false; // CAMBIADO: Iniciar cerrado
	var cboxContainer = document.getElementById("cboxwrap");
	var cboxToggleButton = document.getElementById("cboxbutton");
	
    // CAMBIO: ICONOS EN LUGAR DE TEXTO
    var buttonStringOpen = '<i class="fas fa-comment-dots"></i>'; 
	var buttonStringClose = '<i class="fas fa-times"></i>'; 
	var lsKey = "cbox:isOpen";

	var cboxHTML = '<!-- BEGIN CBOX - www.cbox.ws - v4.3 -->'
	+'<div id="cboxdiv" style="position: relative; margin: 0 auto; width: 300px; font-size: 0; line-height: 0;">'
	+'<div style="position: relative; height: 233px; overflow: auto; overflow-y: auto; -webkit-overflow-scrolling: touch; border: 0px solid;"><iframe src="https://www4.cbox.ws/box/?boxid=3774862&boxtag=a7lslt&sec=main" marginheight="0" marginwidth="0" frameborder="0" width="100%" height="100%" scrolling="auto" allowtransparency="yes" name="cboxmain4-3774862" id="cboxmain4-3774862"></iframe></div>'
	+'<div style="position: relative; height: 147px; overflow: hidden; border: 0px solid; border-top: 0px;"><iframe src="https://www4.cbox.ws/box/?boxid=3774862&boxtag=a7lslt&sec=form" allow="autoplay" marginheight="0" marginwidth="0" frameborder="0" width="100%" height="100%" scrolling="no" allowtransparency="yes" name="cboxform4-3774862" id="cboxform4-3774862"></iframe></div>'
	+'</div>'
	+'<!-- END CBOX -->';

	var htmlInjected = false;
	var isVisible = false;
	var toggleCbox = function (show) {
		
		if (!show) {
			cboxContainer.style.display = "none";
			if (cboxToggleButton) {
				cboxToggleButton.innerHTML = buttonStringOpen;
			}
			
		}
		else {
			cboxContainer.style.display = "block";
			if (cboxToggleButton) {
				cboxToggleButton.innerHTML = buttonStringClose;
			}
		}
		
		if (show && !htmlInjected) {
			cboxContainer.innerHTML = cboxHTML;
			htmlInjected = true;
		}
		
		isVisible = show;
	}

    // INIT: Siempre cerrado al cargar (según instrucción)
	toggleCbox(false); 
    // Eliminamos la lectura de localStorage para que no se abra solo

	if (cboxToggleButton) {
		cboxToggleButton.onclick = function () {
			toggleCbox(!isVisible);
			// No guardamos estado para respetar la instrucción de "siempre cerrado al cargar"
		}
	}
})();

  // --- LÓGICA PRINCIPAL DEL REPRODUCTOR (Sin cambios) ---
  let isPlaying = false; 
  const audio = document.getElementById('radio');
  const playPauseBtn = document.getElementById('playPause');
  const playIcon = playPauseBtn.querySelector('i');
  
  const sourceTitle = document.getElementById('trackTitleSource');
  const sourceArtist = document.getElementById('trackArtistSource');
  const displayTitle = document.getElementById('displayTitle');
  const displayArtist = document.getElementById('displayArtist');
  const albumArt = document.getElementById('albumArt');
  const bgBlur = document.getElementById('bgBlur');
  const albumYearEl = document.getElementById('albumYear');
  
  const currentTimeEl = document.getElementById('currentTime');
  const totalTimeEl = document.getElementById('totalTime');
  const progressFill = document.getElementById('progressFill');

  const modalOverlay = document.getElementById('modalOverlay');
  const modalArtist = document.getElementById('modalArtist');
  const modalTitle = document.getElementById('modalTitle');
  const modalBio = document.getElementById('modalBio');
  const modalAlbum = document.getElementById('modalAlbum');
  const modalGenre = document.getElementById('modalGenre');

  let currentArtistName = "Radiochar";
  let currentSongName = "";
  let currentAlbumName = "";
  let currentGenre = "";

  const DEFAULT_COVER = 'https://bit.ly/4q9Jddl';

  // --- VARIABLES TIMELINE ---
  let songDurationSecs = 0;
  let currentSecs = 0;
  let timelineInterval;
  let startTime = 0;

  document.getElementById('listenerCount').innerText = Math.floor(Math.random() * (50 - 25 + 1) + 25);

  const canvas = document.getElementById('winampVis');
  const ctx = canvas.getContext('2d');
  const TOTAL_BARS = 30; 
  const HALF_BARS = TOTAL_BARS / 2; 
  let peakHeights = new Array(HALF_BARS).fill(0); 

  function animateWinamp() {
    requestAnimationFrame(animateWinamp);
    if (canvas.width !== canvas.clientWidth) { canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let frequencyData = [];
    if (isPlaying) { for(let i=0; i<HALF_BARS; i++) frequencyData.push(Math.random() * 100); }
    else { frequencyData = new Array(HALF_BARS).fill(0); }
    const gap = 3; const barWidth = (canvas.width - (gap * (TOTAL_BARS - 1))) / TOTAL_BARS; 
    ctx.fillStyle = 'rgba(255, 255, 255, 0.1)'; 
    for (let i = 0; i < HALF_BARS; i++) {
        let intensity = frequencyData[i] || 0;
        const decay = 1 - (i * 0.05); let targetHeight = (intensity / 100) * canvas.height * decay;
        if (targetHeight > peakHeights[i]) peakHeights[i] = targetHeight; else peakHeights[i] -= 2; 
        if (peakHeights[i] < 0) peakHeights[i] = 0;
        const h = peakHeights[i]; const center = canvas.width / 2; const xOffset = (i * (barWidth + gap)) + (gap/2);
        ctx.fillRect(center - xOffset - barWidth, canvas.height - h, barWidth, h); 
        ctx.fillRect(center + xOffset, canvas.height - h, barWidth, h); 
    }
  }
  animateWinamp();

  audio.volume = 1.0; 

  playPauseBtn.addEventListener('click', () => {
    if (isPlaying) {
      audio.pause();
      playIcon.classList.remove('fa-pause'); playIcon.classList.add('fa-play'); playPauseBtn.classList.remove('playing');
    } else {
      audio.play().catch(console.error);
      playIcon.classList.remove('fa-play'); playIcon.classList.add('fa-pause'); playPauseBtn.classList.add('playing');
    }
    isPlaying = !isPlaying;
  });

  async function openInfoModal() {
    modalOverlay.classList.add('active');
    modalArtist.innerText = currentArtistName;
    modalTitle.innerText = currentSongName;
    modalAlbum.innerText = currentAlbumName || "Desconocido";
    modalGenre.innerText = currentGenre || "Varios";
    modalBio.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando información de la canción...';

    try {
        const query = `${currentSongName} ${currentArtistName}`;
        const searchUrl = `https://es.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*`;
        
        const searchRes = await fetch(searchUrl);
        const searchData = await searchRes.json();

        if (searchData.query.search.length > 0) {
            const pageTitle = searchData.query.search[0].title;
            const summaryUrl = `https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(pageTitle)}`;
            
            const summaryRes = await fetch(summaryUrl);
            const summaryData = await summaryRes.json();

            if (summaryData.extract) {
                modalBio.innerText = summaryData.extract;
            } else {
                modalBio.innerText = "No se encontró una reseña detallada para esta canción.";
            }
        } else {
             modalBio.innerText = "No se encontró información específica sobre esta canción en Wikipedia.";
        }
    } catch (error) {
        console.error("Wiki Error", error);
        modalBio.innerText = "Error al conectar con la base de datos de información.";
    }
  }

  function closeModal() {
    modalOverlay.classList.remove('active');
  }
  
  modalOverlay.addEventListener('click', (e) => {
      if (e.target === modalOverlay) closeModal();
  });

  function initTimeline(key, durationMillis) {
    clearInterval(timelineInterval);
    
    // --- LÓGICA DE SINCRONIZACIÓN RADIO ---
    // 1. Reducción Heurística: Las radios cortan las canciones. 
    //    Restamos 15 segundos o aplicamos un 85% de la duración de iTunes.
    //    Esto evita que la barra se quede "corta".
    //    Si la canción es corta (menos de 3 min), restamos menos.
    let adjustedDuration = durationMillis;
    if (durationMillis > 180000) { // Si > 3 mins
         adjustedDuration = durationMillis * 0.90; // Reducir 10%
    }
    
    const now = Date.now();
    const savedData = JSON.parse(localStorage.getItem('radioCurrentSong') || '{}');
    
    if (savedData.key === key && savedData.startTime) {
        startTime = savedData.startTime;
    } else {
        startTime = now;
        localStorage.setItem('radioCurrentSong', JSON.stringify({
            key: key,
            startTime: startTime
        }));
    }

    songDurationSecs = adjustedDuration / 1000;
    
    const elapsedSecs = (now - startTime) / 1000;
    currentSecs = elapsedSecs > songDurationSecs ? songDurationSecs : elapsedSecs; 

    totalTimeEl.innerText = formatTime(songDurationSecs);
    updateUI(currentSecs, songDurationSecs);

    timelineInterval = setInterval(() => {
        const currentNow = Date.now();
        const realElapsed = (currentNow - startTime) / 1000;
        
        currentSecs = realElapsed;

        // Tope visual
        if (currentSecs > songDurationSecs) {
           currentSecs = songDurationSecs; 
        }
        
        updateUI(currentSecs, songDurationSecs);

    }, 1000);
  }
  
  function updateUI(current, total) {
     if(total <= 0) return;
     currentTimeEl.innerText = formatTime(current);
     const percent = (current / total) * 100;
     progressFill.style.width = `${percent}%`;
  }

  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
  }

  function toTitleCase(str) {
    return str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  }

  function checkMarquee() {
    const container = document.querySelector('.song-title-container');
    if (!displayTitle || !container) return;
    
    displayTitle.classList.remove('scrolling-text');
    container.classList.remove('is-scrolling'); 
    displayTitle.style.removeProperty('--scroll-distance');
    
    if (displayTitle.scrollWidth > container.offsetWidth) {
      const distance = (displayTitle.scrollWidth - container.offsetWidth + 20) * -1;
      displayTitle.style.setProperty('--scroll-distance', `${distance}px`);
      
      displayTitle.classList.add('scrolling-text');
      container.classList.add('is-scrolling');
    }
  }

  let lastSongKey = ""; 

  async function updateInfo() {
    let artist = sourceArtist.innerText.trim();
    let title = sourceTitle.innerText.trim();
    
    if (!artist || !title) return;

    const formattedArtist = toTitleCase(artist);
    const currentKey = `${formattedArtist}-${title}`;
    
    currentArtistName = formattedArtist;
    currentSongName = title;
    
    if (currentKey === lastSongKey) {
        checkMarquee(); 
        return;
    }
    
    // --- TRUCO VISUAL: CANCIÓN TERMINADA ---
    // Si la canción cambia, forzamos la barra anterior al 100% 
    // para que el usuario sienta que terminó correctamente.
    if (lastSongKey !== "") {
        progressFill.style.transition = "width 0.3s ease";
        progressFill.style.width = "100%";
    }
    
    lastSongKey = currentKey;

    const query = encodeURIComponent(`${artist} ${title}`);
    const url = `https://itunes.apple.com/search?term=${query}&media=music&limit=1`;
    let newCoverUrl = DEFAULT_COVER;
    let newYear = "";
    let durationMillis = 180000; 
    
    currentAlbumName = "";
    currentGenre = "";

    try {
      const res = await fetch(url);
      const data = await res.json();
      if (data.results.length > 0) {
        const track = data.results[0];
        newCoverUrl = track.artworkUrl100.replace('100x100bb', '600x600bb');
        if (track.releaseDate) newYear = track.releaseDate.substring(0, 4);
        if (track.trackTimeMillis) durationMillis = track.trackTimeMillis;
        
        currentAlbumName = track.collectionName;
        currentGenre = track.primaryGenreName;
      }
    } catch (error) { /* Fallback */ }

    displayTitle.classList.add('fading-out');
    displayArtist.classList.add('fading-out');
    albumArt.classList.add('fading-out');
    bgBlur.classList.add('fading-out');
    albumYearEl.classList.add('fading-out');

    const imgLoader = new Image();
    imgLoader.src = newCoverUrl;
    
    setTimeout(() => {
        // Restaurar transición normal
        progressFill.style.transition = "width 1s linear";
        
        displayTitle.innerText = title;
        displayArtist.innerText = formattedArtist;
        albumYearEl.innerText = newYear; 
        
        albumArt.src = newCoverUrl;
        bgBlur.style.backgroundImage = `url('${newCoverUrl}')`;

        initTimeline(currentKey, durationMillis);
        
        checkMarquee();

        displayTitle.classList.remove('fading-out');
        displayArtist.classList.remove('fading-out');
        albumArt.classList.remove('fading-out');
        bgBlur.classList.remove('fading-out');
        albumYearEl.classList.remove('fading-out');
        
        // Recargar historial inmediatamente después de actualizar la info principal
        // Esto ayuda a que el filtro de "canción actual" funcione mejor
        loadRecentTracksFromFeed();
        
    }, 800); 
  }

  const observer = new MutationObserver(() => { setTimeout(updateInfo, 500); });
  if(sourceTitle) {
    observer.observe(sourceTitle, { childList: true, characterData: true, subtree: true });
  }

  setTimeout(updateInfo, 2000);
  window.addEventListener('resize', checkMarquee);

  // -------------------------------------------------------------
  // LÓGICA DE HISTORIAL RECIENTE (Horizontal con Número)
  // -------------------------------------------------------------
  const recentGrid = document.getElementById('recentTracksGrid');
  const filters = ['pisa', 'pisacanciones', 'jingle', 'promo', 'indicativo', 'sello', 'intro', 'podcast', 'comercial', 'cuña', 'radiochar'];

  function cleanTrackText(text) {
      if (!text) return "";
      return text.replace(/^\d+\.?\s*-?/, "").replace(/\(.*\)/g, "").replace(/\[.*\]/g, "").replace(/ft\..*/i, "").replace(/feat\..*/i, "").replace(/remix/i, "").replace(/original mix/i, "").replace(/extended/i, "").replace(/radio edit/i, "").trim();
  }

  // Variable global para almacenar el historial y usarlo en "Sabías que"
  let globalRecentItems = [];

  // Variable para rastrear la última canción usada en "Sabías que" y detectar cambios
  let lastDykTrackTitle = "";

  async function loadRecentTracksFromFeed() {
      if (!recentGrid) return;
      try {
          // AGREGADO: Cache buster para asegurar datos frescos (?_=TIMESTAMP)
          const response = await fetch(`https://cast2.my-control-panel.com/recentfeed/robinson/json/?_=${Date.now()}`);
          if (response.ok) {
              const data = await response.json();
              const items = data.items ? data.items : (Array.isArray(data) ? data : []);
              if (items.length > 0) { 
                  renderTracks(items); 
                  // Lógica de Observador: Solo actualizar si la canción #10 (o última) cambió
                  checkAndUpdateDidYouKnow(items);
                  return; 
              }
          }
      } catch (e) { console.warn("Fallo carga JSON, usando fallback widget...", e); }

      const widget = document.getElementById('cc_recenttracks_original');
      if (widget && widget.children.length > 0) {
          const items = [];
          const rows = widget.querySelectorAll('tr'); 
          const els = rows.length > 0 ? rows : widget.children;
          for(let el of els) {
              let text = el.innerText; 
              const timeMatch = text.match(/(\d{2}:\d{2})/);
              if(timeMatch) text = text.replace(timeMatch[0], '');
              let artist = "Desconocido", title = text;
              if(text.includes('-')) [artist, title] = text.split('-');
              items.push({ artist: artist.trim(), title: title.trim(), image: '' });
          }
          renderTracks(items);
          checkAndUpdateDidYouKnow(items);
      }
  }

  function checkAndUpdateDidYouKnow(rawItems) {
      // Filtrar y limpiar la lista primero para obtener la lista real válida
      let validItems = [];
      for (let i = 0; i < rawItems.length; i++) {
          const item = rawItems[i];
          let rawArtist = item.artist || "", rawTitle = item.title || "";
          if (!rawArtist && rawTitle.includes('-')) { const parts = rawTitle.split('-'); rawArtist = parts[0].trim(); rawTitle = parts.slice(1).join('-').trim(); }
          
          const fullText = `${rawArtist} ${rawTitle}`.toLowerCase();
          if (filters.some(f => fullText.includes(f))) continue;
          
          const cleanTitle = cleanTrackText(rawTitle);
          const cleanArtist = cleanTrackText(rawArtist);
          
          // No excluimos la canción actual aquí porque "Sabías que" puede mostrar cualquiera del historial
          validItems.push({artist: cleanArtist, title: cleanTitle});
      }

      // Obtener la canción objetivo (la #10 o la última disponible si hay menos)
      const targetIndex = Math.min(validItems.length - 1, 9);
      if (targetIndex < 0) return;

      const targetSong = validItems[targetIndex];
      const uniqueId = targetSong.artist + targetSong.title;

      // SOLO ACTUALIZAR SI LA CANCIÓN HA CAMBIADO
      if (uniqueId !== lastDykTrackTitle) {
          lastDykTrackTitle = uniqueId;
          updateDidYouKnow(targetSong);
      }
  }

  function renderTracks(items) {
      if (!recentGrid) return;
      let html = '';
      let count = 1;

      // HORA ACTUAL EN SEGUNDOS PARA EL CÁLCULO
      const nowSec = Math.floor(Date.now() / 1000);
      
      for (let i = 0; i < items.length; i++) {
          const item = items[i];
          let rawArtist = item.artist || "", rawTitle = item.title || "";
          if (!rawArtist && rawTitle.includes('-')) { const parts = rawTitle.split('-'); rawArtist = parts[0].trim(); rawTitle = parts.slice(1).join('-').trim(); }
          const fullText = `${rawArtist} ${rawTitle}`.toLowerCase();
          if (filters.some(f => fullText.includes(f))) continue;
          const cleanTitle = cleanTrackText(rawTitle);
          const cleanArtist = cleanTrackText(rawArtist);
          if (currentSongName && cleanTitle.toLowerCase() === cleanTrackText(currentSongName).toLowerCase()) continue; 
          
          if(count <= 5) { 
              const displayTitle = cleanTitle || rawTitle;
              const displayArtist = cleanArtist || rawArtist || "Radiochar";

              // LÓGICA DE TIEMPO TRANSCURRIDO (CORREGIDA)
              let timeHtml = '';
              // Intentar encontrar el campo de tiempo (time, started, o timestamp)
              const rawTime = item.time || item.started || item.timestamp;
              
              if (rawTime) {
                  const playedTime = parseInt(rawTime);
                  if (!isNaN(playedTime)) {
                      // Calcular diferencia en segundos
                      let diffSec = nowSec - playedTime;
                      
                      // Ajuste de seguridad: Si playedTime es > now*10, probablemente está en milisegundos
                      if (playedTime > nowSec * 100) {
                           diffSec = Math.floor(Date.now()/1000) - Math.floor(playedTime/1000);
                      }

                      let diffMin = Math.floor(diffSec / 60);
                      if (diffMin < 0) diffMin = 0; // Evitar tiempos negativos por diferencias de reloj
                      
                      const timeStr = diffMin === 0 ? "Hace un momento" : `Hace ${diffMin} min`;
                      timeHtml = `<div class="hist-time"><i class="far fa-clock"></i> ${timeStr}</div>`;
                  }
              }

              html += `
                <div class="hist-card" data-artist="${cleanArtist}" data-title="${cleanTitle}">
                    <div class="hist-cover-wrap">
                        <div class="hist-num">${count}</div>
                        <img src="${item.image || DEFAULT_COVER}" alt="Cover" class="hist-cover" onerror="this.src='${DEFAULT_COVER}'">
                    </div>
                    <div class="hist-info">
                        <div class="hist-title" title="${displayTitle}">${displayTitle}</div>
                        <div class="hist-artist" title="${displayArtist}">${displayArtist}</div>
                        ${timeHtml}
                    </div>
                </div>
              `;
              count++;
          }
      }
      if (recentGrid.innerHTML !== html && html !== '') { recentGrid.innerHTML = html; fetchCoversForRecentTracks(); }
  }

  function fetchCoversForRecentTracks() {
      const cards = document.querySelectorAll('.hist-card');
      cards.forEach((card, index) => {
          setTimeout(() => {
              const artist = card.getAttribute('data-artist');
              const title = card.getAttribute('data-title');
              const img = card.querySelector('.hist-cover');
              if (img && !img.dataset.loaded) {
                  let queryTerm = `${artist} ${title}`.replace(/[^\w\sñáéíóúü]/gi, ' ').trim();
                  if (!artist || artist === "Desconocido") queryTerm = title;
                  const url1 = `https://itunes.apple.com/search?term=${encodeURIComponent(queryTerm)}&media=music&entity=song&limit=1`;
                  fetch(url1).then(res => res.json()).then(data => {
                      if (data.results && data.results.length > 0) { img.src = data.results[0].artworkUrl100.replace('100x100bb', '300x300bb'); img.classList.add('loaded'); img.dataset.loaded = "true"; }
                      else {
                           const url2 = `https://itunes.apple.com/search?term=${encodeURIComponent(title)}&media=music&entity=song&limit=1`;
                           return fetch(url2).then(res => res.json());
                      }
                  }).then(data2 => {
                       if (data2 && data2.results && data2.results.length > 0) { img.src = data2.results[0].artworkUrl100.replace('100x100bb', '300x300bb'); }
                       img.classList.add('loaded'); img.dataset.loaded = "true";
                  }).catch(err => { img.classList.add('loaded'); });
              }
          }, index * 100); 
      });
  }
  loadRecentTracksFromFeed();
  setInterval(loadRecentTracksFromFeed, 90000);
  const widgetObserver = new MutationObserver(() => { setTimeout(loadRecentTracksFromFeed, 500); });
  const widgetContainerElement = document.getElementById('cc_recenttracks_original');
  if(widgetContainerElement) widgetObserver.observe(widgetContainerElement, {childList: true, subtree: true, characterData: true});


  // -------------------------------------------------------------
  // LÓGICA DE TOP 5 BILLBOARD 1985 (AUTOMÁTICA - AYER)
  // -------------------------------------------------------------
  const topHitsContainer = document.getElementById('billboardContainer');
  
  const hits1985 = [
      { t: "Careless Whisper", a: "Wham!" }, { t: "Say You, Say Me", a: "Lionel Richie" }, { t: "Separate Lives", a: "Phil Collins" }, { t: "I Want to Know What Love Is", a: "Foreigner" }, { t: "Money for Nothing", a: "Dire Straits" }, { t: "Everybody Wants to Rule the World", a: "Tears for Fears" }, { t: "The Power of Love", a: "Huey Lewis & The News" }, { t: "We Built This City", a: "Starship" }, { t: "St. Elmo's Fire (Man in Motion)", a: "John Parr" }, { t: "Can't Fight This Feeling", a: "REO Speedwagon" }, { t: "Take On Me", a: "a-ha" }, { t: "Don't You (Forget About Me)", a: "Simple Minds" }, { t: "Broken Wings", a: "Mr. Mister" }, { t: "Material Girl", a: "Madonna" }, { t: "Summer of '69", a: "Bryan Adams" }, { t: "Part-Time Lover", a: "Stevie Wonder" }, { t: "Saving All My Love for You", a: "Whitney Houston" }, { t: "Heaven", a: "Bryan Adams" }, { t: "Everything She Wants", a: "Wham!" }, { t: "Cool It Now", a: "New Edition" }, { t: "Miami Vice Theme", a: "Jan Hammer" }, { t: "Alive and Kicking", a: "Simple Minds" }, { t: "Election Day", a: "Arcadia" }, { t: "Party All the Time", a: "Eddie Murphy" }, { t: "Sleeping Bag", a: "ZZ Top" }
  ];

  function getDailyHits() {
      const now = new Date();
      const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1);
      const currentYear = yesterday.getFullYear();
      const start = new Date(currentYear, 0, 0);
      const diff = yesterday - start;
      const oneDay = 1000 * 60 * 60 * 24;
      const dayOfYear = Math.floor(diff / oneDay);
      const startIndex = (dayOfYear * 5) % hits1985.length;
      let dailySelection = [];
      for(let i=0; i<5; i++) { dailySelection.push(hits1985[(startIndex + i) % hits1985.length]); }
      return dailySelection;
  }

  function renderBillboard() {
      if(!topHitsContainer) return;
      const hits = getDailyHits();
      const top1 = hits[0];
      const otherHits = hits.slice(1, 5);

      let html = `
          <!-- #1 HIT -->
          <div class="hit-number-one" data-artist="${top1.a}" data-title="${top1.t}">
              <div class="hit-one-rank-overlay">1</div>
              <img src="${DEFAULT_COVER}" class="hit-one-cover dynamic-cover" alt="${top1.t}">
              <div class="hit-one-info">
                <div class="hit-one-title">${top1.t}</div>
                <div class="hit-one-artist">${top1.a}</div>
              </div>
          </div>
          <!-- LISTA #2 - #5 -->
          <div class="hits-list">
      `;
      otherHits.forEach((hit, index) => {
          const rank = index + 2;
          html += `
              <div class="hit-card" data-artist="${hit.a}" data-title="${hit.t}">
                  <div class="hit-rank-large rank-${rank}">${rank}</div>
                  <div class="hit-small-cover-wrapper">
                      <img src="${DEFAULT_COVER}" class="hit-small-cover dynamic-cover" alt="${hit.t}">
                  </div>
                  <div class="hit-info">
                      <div class="hit-title">${hit.t}</div>
                      <div class="hit-artist">${hit.a}</div>
                  </div>
              </div>
          `;
      });
      html += `</div>`;
      topHitsContainer.innerHTML = html;
      fetchBillboardCovers();
  }

  function fetchBillboardCovers() {
      const items = document.querySelectorAll('.hit-number-one, .hit-card');
      items.forEach((item, index) => {
          setTimeout(() => {
              const artist = item.getAttribute('data-artist');
              const title = item.getAttribute('data-title');
              const img = item.querySelector('.dynamic-cover'); 
              if (img && !img.dataset.loaded) {
                  let queryTerm = `${artist} ${title}`.replace(/[^\w\sñáéíóúü]/gi, ' ').trim();
                  const url = `https://itunes.apple.com/search?term=${encodeURIComponent(queryTerm)}&media=music&entity=song&limit=1`;
                  fetch(url).then(res => res.json()).then(data => {
                      if (data.results && data.results.length > 0) { img.src = data.results[0].artworkUrl100.replace('100x100bb', '600x600bb'); }
                      img.classList.add('loaded'); img.dataset.loaded = "true";
                  }).catch(err => { img.classList.add('loaded'); });
              }
          }, index * 200); 
      });
  }
  renderBillboard();

  // -------------------------------------------------------------
  // FUNCION AUXILIAR: LIMITAR PALABRAS INTELIGENTE
  // -------------------------------------------------------------
  function smartLimitText(text, maxWords) {
      if (!text) return "";
      
      const words = text.trim().split(/\s+/);
      if (words.length <= maxWords) return text;
      
      // Tomamos un chunk inicial algo mayor al limite para buscar el punto
      // Pero como queremos cortar "hasta" el ultimo punto DENTRO o CERCA del limite...
      // Estrategia:
      // 1. Tomar las primeras maxWords.
      // 2. Unirlas.
      // 3. Buscar el último punto (.) en esa cadena recortada.
      // 4. Si se encuentra, cortar ahí.
      // 5. Si no, buscar el primer punto DESPUES del limite (para no dejar frase inconclusa muy corta)
      //    O cortar en el punto anterior. El usuario prefiere "corta hasta el último punto seguido".
      
      // Vamos a reconstruir frase por frase hasta llegar al limite.
      const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
      let result = "";
      let currentWordCount = 0;
      
      for (let i = 0; i < sentences.length; i++) {
          const sentence = sentences[i];
          const sentenceWordCount = sentence.trim().split(/\s+/).length;
          
          // Si agregar esta oracion no pasa el limite (o lo pasa por muy poco, digamos 5 palabras de margen), la agregamos
          if (currentWordCount + sentenceWordCount <= maxWords + 5) {
              result += sentence;
              currentWordCount += sentenceWordCount;
          } else {
              // Si es la primera oracion y es gigante, ni modo, tenemos que cortarla a la fuerza o mostrarla completa?
              // Usuario: "verificando la lógica y el sentido... Es mejor dejar el texto hasta esta instancia"
              if (result === "") {
                   // Caso extremo: Primera oracion larguisima.
                   // Tratamos de buscar una coma o punto y coma anterior al limite
                   const cutChunk = words.slice(0, maxWords).join(" ");
                   const lastPunctuation = Math.max(cutChunk.lastIndexOf(","), cutChunk.lastIndexOf(";"));
                   if (lastPunctuation > maxWords * 3) { // Si hay una pausa decente
                       return cutChunk.substring(0, lastPunctuation + 1);
                   }
                   // Fallback: Devolver la primera oracion completa aunque sea larga es mejor que cortarla mal.
                   return sentence; 
              }
              break; // Ya tenemos suficiente texto con oraciones completas
          }
      }
      return result.trim();
  }

  // -------------------------------------------------------------
  // LÓGICA DE "¿SABÍAS QUE...?" (Optimizada con Observador)
  // -------------------------------------------------------------
  async function updateDidYouKnow(song) {
      if(!song) return;
      
      const container = document.getElementById('didYouKnowContainer');
      const coverImg = document.getElementById('dykCover');
      
      container.style.display = 'block';
      document.getElementById('dykTitle').innerText = song.title;
      document.getElementById('dykArtist').innerText = song.artist;

      try {
          const query = encodeURIComponent(`${song.artist} ${song.title}`);
          
          // 1. iTunes (Datos)
          const itunesRes = await fetch(`https://itunes.apple.com/search?term=${query}&media=music&entity=song&limit=1`);
          const itunesData = await itunesRes.json();
          
          if (itunesData.results.length > 0) {
              const track = itunesData.results[0];
              coverImg.src = track.artworkUrl100.replace('100x100bb', '600x600bb');
              document.getElementById('dykAlbum').querySelector('span').innerText = track.collectionName;
              document.getElementById('dykYear').querySelector('span').innerText = track.releaseDate.substring(0, 4);
          } else {
              coverImg.src = DEFAULT_COVER;
          }

          // 2. Wikipedia (Reseña)
          // Buscar snippet en español
          const wikiSearchRes = await fetch(`https://es.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(song.artist + ' ' + song.title)}&format=json&origin=*`);
          const wikiSearchData = await wikiSearchRes.json();

          if (wikiSearchData.query.search.length > 0) {
              const pageTitle = wikiSearchData.query.search[0].title;
              const summaryRes = await fetch(`https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(pageTitle)}`);
              const summaryData = await summaryRes.json();
              
              if (summaryData.extract) {
                  let text = summaryData.extract;
                  // APLICAR LIMITE INTELIGENTE (50 palabras aprox)
                  text = smartLimitText(text, 50);
                  document.getElementById('dykText').innerText = text;
              } else { throw new Error("No extract"); }
          } else { throw new Error("No wiki result"); }

      } catch (e) {
          // Fallback
          const fallbackText = "Un clásico atemporal. La música de los 80s y 90s marcó una era dorada con sintetizadores icónicos y letras inolvidables que definieron a toda una generación.";
          document.getElementById('dykText').innerText = smartLimitText(fallbackText, 50);
          if(!coverImg.src || coverImg.src === "") coverImg.src = DEFAULT_COVER;
      }
  }


  // -------------------------------------------------------------
  // LÓGICA DE "UN DÍA COMO HOY (1985)" (EFEMÉRIDES - Google Search API Simulado)
  // -------------------------------------------------------------
  // Nota: Dado que no tenemos acceso real a la API de Búsqueda de Google en vivo en este entorno estático,
  // mantendremos la base de datos simulada pero con la estructura solicitada para que parezca una noticia real.
  
  // Base de datos de efemérides (Meses indexados 0-11)
  const musicNews1985 = {
      11: { // Diciembre
          15: { title: "15 de Diciembre de 1985: Ecos de Live Aid y Pop Global", body: "El 15 de diciembre de 1985, la música vivía el eco de eventos gigantes como Live Aid (julio 1985) y el furor de éxitos pop y rock como 'We Are The World' y A-ha, mientras la industria debatía sobre censura (el caso Judas Priest) y se lanzaban discos clave en español (Hombres G, Mecano, Alaska y Dinarama), consolidando una era de música benéfica y pop global que definiría los 80.", imgTerm: "Live Aid 1985" }
      }
  };

  // Datos genéricos por mes si no hay efeméride exacta
  const monthlyHighlights = [
      { t: "Enero 1985: Foreigner en la Cima", b: "El año comenzó con 'I Want to Know What Love Is' de Foreigner dominando las listas de todo el mundo. Esta balada poderosa definió el sonido del rock suave de la época.", imgTerm: "Foreigner band" },
      { t: "Febrero 1985: Madonna arrasa", b: "El álbum 'Like a Virgin' de Madonna se consolidaba como el fenómeno pop del año. Su estilo y actitud marcaron tendencia en la moda juvenil global.", imgTerm: "Madonna 1985" },
      { t: "Marzo 1985: USA for Africa", b: "El lanzamiento de 'We Are The World' marcó un hito en la historia de la música y la solidaridad. Las mayores estrellas se unieron por una causa humanitaria.", imgTerm: "We Are The World" },
      { t: "Abril 1985: Wham! en China", b: "El dúo británico Wham! se convirtió en el primer grupo pop occidental en actuar en la China comunista. Fue un evento cultural histórico de apertura.", imgTerm: "Wham band" },
      { t: "Mayo 1985: Dire Straits y el CD", b: "Se lanzó 'Brothers in Arms', el álbum que impulsó masivamente la adopción del formato CD. Su calidad de sonido digital fue revolucionaria.", imgTerm: "Dire Straits Brothers in Arms" },
      { t: "Junio 1985: Bryan Adams", b: "'Heaven' de Bryan Adams alcanzó el número 1, convirtiéndose en una de las baladas más recordadas de la década. El álbum Reckless dominaba las listas.", imgTerm: "Bryan Adams Reckless" },
      { t: "Julio 1985: Live Aid", b: "El mundo se detuvo para ver el concierto Live Aid, recaudando millones para Etiopía. Queen ofreció una de las mejores actuaciones de rock de la historia.", imgTerm: "Live Aid Queen" },
      { t: "Agosto 1985: The Power of Love", b: "Huey Lewis & The News alcanzaron el éxito masivo gracias a la película 'Volver al Futuro'. La canción se convirtió en un himno de la cultura pop.", imgTerm: "Huey Lewis Back to the Future" },
      { t: "Septiembre 1985: Money for Nothing", b: "El innovador video musical de Dire Straits dominaba la programación de MTV. La animación por computadora marcó un antes y un después.", imgTerm: "Dire Straits Money for Nothing" },
      { t: "Octubre 1985: a-ha conquista América", b: "'Take On Me' llevó el synth-pop noruego a la cima de las listas estadounidenses. Su video mezcla de dibujo y realidad sigue siendo icónico.", imgTerm: "a-ha Take On Me" },
      { t: "Noviembre 1985: We Built This City", b: "Starship lanzó su polémico pero exitoso himno 'We Built This City'. Una oda al rock y a la radio que dividió a la crítica pero amó el público.", imgTerm: "Starship band" },
      { t: "Diciembre 1985: Lionel Richie", b: "Lionel Richie cerró el año con el éxito de 'Say You, Say Me', ganando el Oscar a mejor canción. Consolidó su estatus como rey de las baladas.", imgTerm: "Lionel Richie 1985" }
  ];

  function updateMusicNews() {
      const now = new Date();
      const month = now.getMonth();
      const day = now.getDate();
      
      const newsImage = document.getElementById('newsImage');
      const newsDateBadge = document.getElementById('newsDateBadge');
      const newsHeadline = document.getElementById('newsHeadline');
      const newsBody = document.getElementById('newsBody');
      
      // Formatear fecha
      const dateOptions = { day: 'numeric', month: 'long' };
      const dateStr = now.toLocaleDateString('es-ES', dateOptions);
      newsDateBadge.innerText = dateStr;

      // Buscar evento específico
      let newsItem = null;
      let searchQuery = "";

      if (musicNews1985[month] && musicNews1985[month][day]) {
          newsItem = musicNews1985[month][day];
          searchQuery = newsItem.imgTerm;
      } else {
          // Si no hay evento exacto, usar el destacado del mes
          const highlight = monthlyHighlights[month];
          newsItem = {
              title: highlight.t,
              body: highlight.b
          };
          searchQuery = highlight.imgTerm;
      }

      newsHeadline.innerText = newsItem.title;
      // APLICAR LIMITE INTELIGENTE (50)
      newsBody.innerText = smartLimitText(newsItem.body, 50);

      // Buscar imagen en iTunes basada en el término clave
      searchNewsImage(searchQuery);
  }
  
  async function searchNewsImage(query) {
      if(!query) return;
      try {
          const url = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&limit=1`;
          const res = await fetch(url);
          const data = await res.json();
          
          if(data.results.length > 0) {
              // Preferir imagen de artista o album
              const item = data.results[0];
              document.getElementById('newsImage').src = item.artworkUrl100.replace('100x100bb', '600x600bb');
          }
      } catch(e) {
          // Dejar la imagen default
      }
  }

  // Inicializar Noticia
  updateMusicNews();

</script>

</body>
</html>
