<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RADIOCHAR - Hits 80s/90s</title>
  
  <!-- 1. Iconos (FontAwesome) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  
  <!-- 2. Fuente para el Título (Sarina) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarina&display=swap" rel="stylesheet">

  <style>
    /* --- RESET Y BASE --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #fff;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    /* --- FONDO AMBIENTAL (Blur) --- */
    .background-blur {
      position: fixed; top: -10%; left: -10%; width: 120%; height: 120%;
      z-index: -1;
      /* Imagen por defecto inicial */
      background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiSHNsDw3OZJEWNaqSm4hhstR9w8wF7TGzq_LMvnSt9ELIK_kIYyYLf_JHppvCkJNlMilGo0pKTh5XWas9cXEaR6f_GHQXi6qsn_ke6Zdpgv1imwbbkq_H9Uua9ZrdJ3hvKVlKQEf01qDxcwDEwdVFAtsXHknuMCgpno53zm2SHjgts2fhpC3MGPNU4BvJS/s16000/radiochar.online.png');
      background-size: cover; background-position: center;
      filter: blur(45px) brightness(0.4);
      transition: background-image 1s ease-in-out;
    }

    /* --- TÍTULO (SARINA) - ESTILO VHS GLITCH --- */
    .radio-title {
      font-family: 'Sarina', cursive;
      font-size: 70px;
      color: #ffffff;
      text-align: center;
      z-index: 5;
      letter-spacing: 2px;
      margin-bottom: 30px;
      position: relative;
      text-shadow: 3px 0px 0px rgba(255, 0, 0, 0.8), -3px 0px 0px rgba(0, 0, 255, 0.8);
      animation: vhsGlitch 3s infinite alternate-reverse;
    }

    @keyframes vhsGlitch {
      0% { text-shadow: 3px 0 rgba(255,0,0,0.8), -3px 0 rgba(0,0,255,0.8); transform: skew(0deg); }
      15% { text-shadow: 3px 0 rgba(255,0,0,0.8), -3px 0 rgba(0,0,255,0.8); transform: skew(0deg); }
      16% { text-shadow: -3px 0 rgba(255,0,0,0.8), 3px 0 rgba(0,0,255,0.8); transform: skew(-2deg); }
      17% { text-shadow: 3px 0 rgba(255,0,0,0.8), -3px 0 rgba(0,0,255,0.8); transform: skew(0deg); }
      40% { opacity: 1; }
      41% { opacity: 0.9; }
      42% { opacity: 1; }
      65% { text-shadow: 3px 0 rgba(255,0,0,0.8), -3px 0 rgba(0,0,255,0.8); transform: skew(0deg); }
      66% { text-shadow: 3px 2px rgba(255,0,0,0.8), -3px -2px rgba(0,0,255,0.8); transform: skew(1deg); }
      67% { text-shadow: 3px 0 rgba(255,0,0,0.8), -3px 0 rgba(0,0,255,0.8); transform: skew(0deg); }
      100% { text-shadow: 3px 0 rgba(255,0,0,0.8), -3px 0 rgba(0,0,255,0.8); transform: skew(0deg); }
    }

    .radio-title::after {
      content: attr(data-text);
      position: absolute; left: 0; top: 0; width: 100%; height: 100%;
      background: repeating-linear-gradient(to bottom, transparent 0px, transparent 2px, rgba(0, 0, 0, 0.3) 2px, rgba(0, 0, 0, 0.3) 4px);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      pointer-events: none; opacity: 0.7;
    }

    /* --- PANTALLA DE CARGA --- */
    .splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 100;
      animation: fadeOut 1s 3s forwards;
      pointer-events: none;
    }
    .splash-screen h1 { font-family: 'Sarina', cursive; font-size: 30px; color: #fff; margin-bottom: 20px; }
    .spinner { border: 4px solid #333; border-top: 4px solid #fff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

    /* --- CONTENEDOR DEL REPRODUCTOR --- */
    .radio-container {
      display: flex;
      width: 800px; max-width: 95%; height: 280px;
      background: rgba(20, 20, 20, 0.85);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.7);
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .cover {
      flex: 0 0 280px;
      background-color: #000;
      position: relative;
      overflow: hidden;
    }
    .cover img {
      width: 100%; height: 100%; object-fit: cover;
      display: block; transition: transform 0.5s ease;
    }

    /* --- LIVE INDICATOR --- */
    .live-indicator {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 10px;
      border-radius: 12px;
      backdrop-filter: blur(4px);
      z-index: 10;
      letter-spacing: 0.5px;
    }

    .live-dot {
      width: 10px; height: 10px; border-radius: 50%; background-color: #ff4444;
      box-shadow: 0 0 8px #ff4444; animation: blink 1.5s infinite ease-in-out;
    }
    @keyframes blink { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(0.8); } }


    .player {
      flex: 1;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      padding: 20px;
      position: relative;
      overflow: hidden; /* Importante para que el texto no se salga del contenedor */
    }

    /* --- CANVAS WINAMP --- */
    #winampVis {
      position: absolute;
      bottom: 25px;
      left: 30px;
      z-index: 10;
    }

    /* --- ESTILOS DEL TÍTULO DE CANCIÓN (CON MARQUESINA) --- */
    .song-title-container {
      width: 100%;
      overflow: hidden;
      white-space: nowrap;
      margin-bottom: 8px;
      text-align: center; /* Centrado por defecto */
      position: relative;
    }

    .song-title {
      font-size: 26px; 
      font-weight: bold; 
      display: inline-block;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      /* La animación se inyectará vía JS si es necesario */
    }

    /* Clase para activar el movimiento */
    .scrolling-text {
      animation: scroll-text 10s linear infinite alternate;
      padding-left: 0;
    }

    @keyframes scroll-text {
      0% { transform: translateX(0); }
      20% { transform: translateX(0); } /* Pausa inicial para leer */
      80% { transform: translateX(var(--scroll-distance)); } /* Desplazamiento */
      100% { transform: translateX(var(--scroll-distance)); } /* Pausa final */
    }

    .artist-name {
      font-size: 18px; color: #bbb; margin-bottom: 30px; text-align: center;
      font-weight: 300; text-transform: none; letter-spacing: 1px;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .controls button {
      background: none; border: none;
      font-size: 75px; color: #fff; cursor: pointer;
      transition: all 0.3s ease;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
    }
    .controls button:hover { transform: scale(1.1); color: #00bfff; }

    .volume-container {
      position: absolute; bottom: 25px; right: 30px;
      display: flex; flex-direction: column; align-items: center; gap: 8px;
    }
    .volume-bar input[type="range"] {
      writing-mode: bt-lr; -webkit-appearance: slider-vertical;
      width: 6px; height: 80px; accent-color: #ffffff; cursor: pointer;
      background: rgba(255,255,255,0.1); border-radius: 3px;
    }

    .creator-footer { margin-top: 20px; font-size: 14px; color: rgba(255, 255, 255, 0.6); text-align: center; z-index: 5; }
    .creator-footer a { color: #00bfff; text-decoration: none; border-bottom: 1px solid transparent; transition: border-bottom 0.3s; }
    .creator-footer a:hover { border-bottom: 1px solid #00bfff; }

    /* --- RESPONSIVE --- */
    @media (max-width: 600px) {
      .radio-container { flex-direction: column; height: auto; width: 90%; }
      .cover { flex: 0 0 300px; height: 300px; }
      .player { padding: 30px 20px; }
      
      .live-indicator { top: 10px; right: 10px; }
      .volume-container { right: 20px; bottom: 20px; }
      #winampVis { left: 20px; bottom: 20px; }
      
      .radio-title { font-size: 40px; }
    }
  </style>
</head>
<body>

<!-- 1. Fondo Blur -->
<div class="background-blur" id="bgBlur"></div>

<!-- 2. Pantalla de carga -->
<div class="splash-screen">
  <h1>Cargando...</h1>
  <div class="spinner"></div>
</div>

<!-- 3. TÍTULO ESTILO VHS GLITCH -->
<h1 class="radio-title" data-text="Radiochar">Radiochar</h1>

<!-- 4. REPRODUCTOR -->
<div class="radio-container">
  
  <div class="cover">
    <div class="live-indicator">
      <div class="live-dot"></div>
      LIVE
    </div>
    <!-- Imagen por defecto actualizada -->
    <img id="albumArt" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiSHNsDw3OZJEWNaqSm4hhstR9w8wF7TGzq_LMvnSt9ELIK_kIYyYLf_JHppvCkJNlMilGo0pKTh5XWas9cXEaR6f_GHQXi6qsn_ke6Zdpgv1imwbbkq_H9Uua9ZrdJ3hvKVlKQEf01qDxcwDEwdVFAtsXHknuMCgpno53zm2SHjgts2fhpC3MGPNU4BvJS/s16000/radiochar.online.png" alt="Album Art" />
  </div>

  <div class="player">
    
    <!-- CANVAS WINAMP (4 Barras) -->
    <canvas id="winampVis" width="40" height="30"></canvas>

    <!-- Contenedor del título con lógica de marquesina -->
    <div class="song-title-container">
        <div id="trackTitle" class="song-title cc_streaminfo" data-type="tracktitle" data-username="robinson">Conectando...</div>
    </div>
    
    <div id="trackArtist" class="artist-name cc_streaminfo" data-type="trackartist" data-username="robinson">Radiochar</div>
    
    <div class="controls">
      <button id="playPause"><i class="fas fa-play-circle"></i></button>
    </div>

    <div class="volume-container">
      <i class="fas fa-volume-up"></i>
      <div class="volume-bar">
        <input type="range" id="volume" min="0" max="1" step="0.01" value="0.5" />
      </div>
    </div>
    
  </div>
</div>

<!-- 5. CRÉDITOS ACTUALIZADOS -->
<div class="creator-footer">
  Powered by <a href="https://www.robinsonchar.online/" target="_blank">robinsonchar</a>
</div>

<!-- 6. SCRIPTS -->
<audio id="radio" src="https://cast2.my-control-panel.com/proxy/robinson/stream" crossorigin="anonymous"></audio>
<script src="https://cast2.my-control-panel.com/system/streaminfo.js"></script>

<script>
  // --- REFERENCIAS ---
  const audio = document.getElementById('radio');
  const playPauseBtn = document.getElementById('playPause');
  const volume = document.getElementById('volume');
  const icon = playPauseBtn.querySelector('i');
  
  const artistElement = document.getElementById('trackArtist');
  const titleElement = document.getElementById('trackTitle');
  const albumArt = document.getElementById('albumArt');
  const bgBlur = document.getElementById('bgBlur');

  // URL DE IMAGEN POR DEFECTO (GOOGLE BLOGGER)
  const DEFAULT_COVER = 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiSHNsDw3OZJEWNaqSm4hhstR9w8wF7TGzq_LMvnSt9ELIK_kIYyYLf_JHppvCkJNlMilGo0pKTh5XWas9cXEaR6f_GHQXi6qsn_ke6Zdpgv1imwbbkq_H9Uua9ZrdJ3hvKVlKQEf01qDxcwDEwdVFAtsXHknuMCgpno53zm2SHjgts2fhpC3MGPNU4BvJS/s16000/radiochar.online.png';

  // --- AUDIO CONTEXT & WINAMP VISUALIZER ---
  let audioContext, analyser, source;
  let isAudioContextSetup = false;
  
  const BAR_COUNT = 4;
  let peakHeights = new Array(BAR_COUNT).fill(0); 
  const PEAK_DROP_SPEED = 0.5;
  const BLOCK_HEIGHT = 2;
  const BLOCK_GAP = 1;      
  const BLOCK_UNIT = BLOCK_HEIGHT + BLOCK_GAP; 

  function setupAudioContext() {
    if (isAudioContextSetup) return;
    try {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      audioContext = new AudioContext();
      analyser = audioContext.createAnalyser();
      source = audioContext.createMediaElementSource(audio);
      source.connect(analyser);
      analyser.connect(audioContext.destination);
      analyser.fftSize = 64; 
      isAudioContextSetup = true;
      animateWinamp();
    } catch (e) {
      console.warn("AudioContext Fallback");
      animateWinamp();
    }
  }

  const canvas = document.getElementById('winampVis');
  const ctx = canvas.getContext('2d');

  function getSegmentColor(y, height) {
    const percentage = 1 - (y / height);
    if (percentage > 0.85) return '#ff3333';
    if (percentage > 0.60) return '#ffaa00';
    return '#33ff33';
  }

  function animateWinamp() {
    requestAnimationFrame(animateWinamp);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let frequencyData = [];

    if (analyser && isPlaying && audioContext.state === 'running') {
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteFrequencyData(dataArray);
      
      const step = Math.floor(bufferLength / BAR_COUNT);
      for (let i = 0; i < BAR_COUNT; i++) {
        let sum = 0;
        let count = 0;
        for (let j = 0; j < step; j++) {
            const index = (i * step) + j;
            if(index < bufferLength) {
                sum += dataArray[index];
                count++;
            }
        }
        frequencyData.push(sum / count);
      }
    } else {
      if(isPlaying) {
         for(let i=0; i<BAR_COUNT; i++) frequencyData.push(Math.random() * 100);
      } else {
         frequencyData = [0,0,0,0];
      }
    }

    const barWidth = 8;
    const gap = 2;
    const totalW = (barWidth * BAR_COUNT) + (gap * (BAR_COUNT-1));
    const startX = (canvas.width - totalW) / 2;

    for (let i = 0; i < BAR_COUNT; i++) {
        const intensity = frequencyData[i] || 0;
        const targetHeight = (intensity / 255) * canvas.height;
        const x = startX + i * (barWidth + gap);

        const numBlocks = Math.floor(targetHeight / BLOCK_UNIT);
        for (let b = 0; b < numBlocks; b++) {
            const yBlock = canvas.height - (b * BLOCK_UNIT) - BLOCK_HEIGHT;
            ctx.fillStyle = getSegmentColor(yBlock, canvas.height);
            ctx.fillRect(x, yBlock, barWidth, BLOCK_HEIGHT);
        }

        if (targetHeight > peakHeights[i]) {
            peakHeights[i] = targetHeight;
        } else {
            peakHeights[i] -= PEAK_DROP_SPEED;
            if (peakHeights[i] < 0) peakHeights[i] = 0;
        }

        if (peakHeights[i] > BLOCK_UNIT) {
            const peakBlockIndex = Math.floor(peakHeights[i] / BLOCK_UNIT);
            const yPeak = canvas.height - (peakBlockIndex * BLOCK_UNIT) - BLOCK_HEIGHT;
            ctx.fillStyle = getSegmentColor(yPeak, canvas.height);
            ctx.fillRect(x, yPeak, barWidth, BLOCK_HEIGHT);
        }
    }
  }

  // --- LÓGICA REPRODUCTOR ---
  let isPlaying = false;
  audio.volume = 0.5;

  playPauseBtn.addEventListener('click', () => {
    if (!isAudioContextSetup) setupAudioContext();
    if (audioContext && audioContext.state === 'suspended') audioContext.resume();

    if (isPlaying) {
      audio.pause();
      icon.classList.remove('fa-stop-circle');
      icon.classList.add('fa-play-circle');
    } else {
      audio.play().catch(e => console.error(e));
      icon.classList.remove('fa-play-circle');
      icon.classList.add('fa-stop-circle');
    }
    isPlaying = !isPlaying;
  });

  volume.addEventListener('input', () => { audio.volume = volume.value; });

  function toTitleCase(str) {
    return str.toLowerCase().split(' ').map(function(word) {
      return word.charAt(0).toUpperCase() + word.slice(1);
    }).join(' ');
  }

  // --- FUNCIÓN DE MARQUESINA (Scroll Text) ---
  function checkMarquee() {
    const titleElement = document.getElementById('trackTitle');
    const container = document.querySelector('.song-title-container');
    
    if (!titleElement || !container) return;

    // Resetear clases y estilos para medir
    titleElement.classList.remove('scrolling-text');
    titleElement.style.removeProperty('--scroll-distance');

    // Comprobar si el texto es más largo que el contenedor
    // offsetWidth = ancho visible, scrollWidth = ancho total del contenido
    if (titleElement.scrollWidth > container.offsetWidth) {
      // Calcular cuánto se debe mover (ancho del texto - ancho visible + un poco de margen)
      const distance = (titleElement.scrollWidth - container.offsetWidth + 20) * -1;
      
      // Aplicar variable CSS
      titleElement.style.setProperty('--scroll-distance', `${distance}px`);
      // Activar animación
      titleElement.classList.add('scrolling-text');
    }
  }

  // --- ACTUALIZACIÓN DE DATOS Y PORTADA ---
  async function updateInfo() {
    let artist = artistElement.innerText.trim();
    let title = titleElement.innerText.trim();
    
    // 1. Formatear texto del artista
    const formattedArtist = toTitleCase(artist);
    if (artist !== formattedArtist && !artist.includes("Radio Online")) {
        artistElement.innerText = formattedArtist;
        artist = formattedArtist;
    }
    
    // 2. Verificar Marquesina (Scroll)
    checkMarquee();

    if (!artist || !title || title.includes('Conectando') || artist.includes('Radio Online')) return;

    // 3. Buscar Portada en iTunes (Solo automático, sin manuales)
    const query = encodeURIComponent(`${artist} ${title}`);
    const url = `https://itunes.apple.com/search?term=${query}&media=music&limit=1`;
    
    try {
      const res = await fetch(url);
      const data = await res.json();
      if (data.results.length > 0) {
        const highResUrl = data.results[0].artworkUrl100.replace('100x100bb', '600x600bb');
        albumArt.src = highResUrl;
        bgBlur.style.backgroundImage = `url('${highResUrl}')`;
      } else {
        albumArt.src = DEFAULT_COVER;
        bgBlur.style.backgroundImage = `url('${DEFAULT_COVER}')`;
      }
    } catch (error) { 
        albumArt.src = DEFAULT_COVER;
        bgBlur.style.backgroundImage = `url('${DEFAULT_COVER}')`;
    }
  }

  const observer = new MutationObserver(() => { setTimeout(updateInfo, 1500); });
  if(titleElement) {
    observer.observe(titleElement, { childList: true, characterData: true, subtree: true });
  }
  
  // Ejecutar al inicio y también si cambia el tamaño de la ventana (para recalcular marquesina)
  setTimeout(updateInfo, 2000);
  window.addEventListener('resize', checkMarquee);

</script>

</body>
</html>
