<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RADIOCHAR - Hits 80s/90s</title>
  
  <!-- 1. Iconos (FontAwesome) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  
  <!-- 2. Fuente para el Título (Sarina) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarina&display=swap" rel="stylesheet">

  <style>
    /* --- RESET Y BASE --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #fff;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    /* --- FONDO AMBIENTAL (Blur) --- */
    .background-blur {
      position: fixed; top: -10%; left: -10%; width: 120%; height: 120%;
      z-index: -1;
      background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiSHNsDw3OZJEWNaqSm4hhstR9w8wF7TGzq_LMvnSt9ELIK_kIYyYLf_JHppvCkJNlMilGo0pKTh5XWas9cXEaR6f_GHQXi6qsn_ke6Zdpgv1imwbbkq_H9Uua9ZrdJ3hvKVlKQEf01qDxcwDEwdVFAtsXHknuMCgpno53zm2SHjgts2fhpC3MGPNU4BvJS/s16000/radiochar.online.png');
      background-size: cover; background-position: center;
      filter: blur(45px) brightness(0.4);
      will-change: opacity, background-image;
    }

    /* --- CLASES DE TRANSICIÓN SUAVE --- */
    .visual-transition {
      transition: opacity 0.8s ease-in-out;
      opacity: 1;
    }
    .visual-transition.fading-out {
      opacity: 0;
    }

    /* --- CONTADOR DE OYENTES (Solo Icono y Numero) --- */
    .listeners-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 12px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: bold;
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(5px);
      z-index: 20;
    }

    /* --- TÍTULO (SARINA) - ESTILO VHS GLITCH --- */
    .radio-title {
      font-family: 'Sarina', cursive;
      font-size: 70px;
      color: #ffffff;
      text-align: center;
      z-index: 5;
      letter-spacing: 2px;
      margin-bottom: 30px;
      position: relative;
      text-shadow: 3px 0px 0px rgba(255, 0, 0, 0.8), -3px 0px 0px rgba(0, 0, 255, 0.8);
      animation: vhsGlitch 3s infinite alternate-reverse;
    }

    @keyframes vhsGlitch {
      0% { text-shadow: 3px 0 rgba(255,0,0,0.8), -3px 0 rgba(0,0,255,0.8); transform: skew(0deg); }
      15% { text-shadow: 3px 0 rgba(255,0,0,0.8), -3px 0 rgba(0,0,255,0.8); transform: skew(0deg); }
      16% { text-shadow: -3px 0 rgba(255,0,0,0.8), 3px 0 rgba(0,0,255,0.8); transform: skew(-2deg); }
      17% { text-shadow: 3px 0 rgba(255,0,0,0.8), -3px 0 rgba(0,0,255,0.8); transform: skew(0deg); }
      40% { opacity: 1; }
      41% { opacity: 0.9; }
      42% { opacity: 1; }
      65% { text-shadow: 3px 0 rgba(255,0,0,0.8), -3px 0 rgba(0,0,255,0.8); transform: skew(0deg); }
      66% { text-shadow: 3px 2px rgba(255,0,0,0.8), -3px -2px rgba(0,0,255,0.8); transform: skew(1deg); }
      67% { text-shadow: 3px 0 rgba(255,0,0,0.8), -3px 0 rgba(0,0,255,0.8); transform: skew(0deg); }
      100% { text-shadow: 3px 0 rgba(255,0,0,0.8), -3px 0 rgba(0,0,255,0.8); transform: skew(0deg); }
    }

    .radio-title::after {
      content: attr(data-text);
      position: absolute; left: 0; top: 0; width: 100%; height: 100%;
      background: repeating-linear-gradient(to bottom, transparent 0px, transparent 2px, rgba(0, 0, 0, 0.3) 2px, rgba(0, 0, 0, 0.3) 4px);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      pointer-events: none; opacity: 0.7;
    }

    /* --- PANTALLA DE CARGA --- */
    .splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 100;
      animation: fadeOut 1s 3s forwards;
      pointer-events: none;
    }
    .splash-screen h1 { font-family: 'Sarina', cursive; font-size: 30px; color: #fff; margin-bottom: 20px; }
    .spinner { border: 4px solid #333; border-top: 4px solid #fff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

    /* --- CONTENEDOR DEL REPRODUCTOR --- */
    .radio-container {
      display: flex;
      width: 800px; max-width: 95%; height: 280px;
      background: rgba(20, 20, 20, 0.85);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.7);
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .cover {
      flex: 0 0 280px;
      background-color: #000;
      position: relative;
      overflow: hidden;
    }
    .cover img {
      width: 100%; height: 100%; object-fit: cover;
      display: block; 
    }

    /* --- AÑO DE CANCIÓN (BLANCO) --- */
    .album-year-badge {
      position: absolute;
      top: 15px;
      left: 15px;
      background: #ffffff;
      color: #000000;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 800;
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      transition: opacity 0.5s ease;
    }
    .album-year-badge:empty { opacity: 0; }

    /* --- PANEL DERECHO (PLAYER) --- */
    .player {
      flex: 1;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    /* --- LIVE INDICATOR (Ahora debajo del botón) --- */
    .live-indicator {
      /* Posicionamiento en el flujo normal (flex), no absoluto */
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 10px;
      border-radius: 12px;
      backdrop-filter: blur(4px);
      z-index: 10;
      letter-spacing: 0.5px;
    }

    .live-dot {
      width: 10px; height: 10px; border-radius: 50%; background-color: #ff4444;
      box-shadow: 0 0 8px #ff4444; animation: blink 1.5s infinite ease-in-out;
    }
    @keyframes blink { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(0.8); } }

    /* --- CANVAS WINAMP --- */
    #winampVis {
      position: absolute;
      bottom: 25px;
      left: 30px;
      z-index: 10;
    }

    /* --- ESTILOS DEL TÍTULO DE CANCIÓN --- */
    .song-title-container {
      width: 100%;
      overflow: hidden;
      white-space: nowrap;
      margin-bottom: 8px;
      text-align: center;
      position: relative;
    }

    .song-title {
      font-size: 26px; 
      font-weight: bold; 
      display: inline-block;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .scrolling-text {
      animation: scroll-text 10s linear infinite alternate;
      padding-left: 0;
    }

    @keyframes scroll-text {
      0% { transform: translateX(0); }
      20% { transform: translateX(0); }
      80% { transform: translateX(var(--scroll-distance)); }
      100% { transform: translateX(var(--scroll-distance)); }
    }

    .artist-name {
      font-size: 18px; color: #bbb; margin-bottom: 25px; text-align: center;
      font-weight: 300; text-transform: none; letter-spacing: 1px;
      width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .controls button {
      background: none; border: none;
      font-size: 75px; color: #fff; cursor: pointer;
      transition: all 0.3s ease;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
    }
    .controls button:hover { transform: scale(1.1); color: #00bfff; }

    .volume-container {
      position: absolute; bottom: 25px; right: 30px;
      display: flex; flex-direction: column; align-items: center; gap: 8px;
    }
    .volume-bar input[type="range"] {
      writing-mode: bt-lr; -webkit-appearance: slider-vertical;
      width: 6px; height: 80px; accent-color: #ffffff; cursor: pointer;
      background: rgba(255,255,255,0.1); border-radius: 3px;
    }

    .creator-footer { margin-top: 20px; font-size: 14px; color: rgba(255, 255, 255, 0.6); text-align: center; z-index: 5; }
    
    /* ENLACE DE CRÉDITOS BLANCO */
    .creator-footer a { 
      color: #ffffff;
      text-decoration: none; 
      border-bottom: 1px solid transparent; 
      transition: border-bottom 0.3s; 
    }
    .creator-footer a:hover { border-bottom: 1px solid #ffffff; }

    /* --- RESPONSIVE --- */
    @media (max-width: 600px) {
      .radio-container { flex-direction: column; height: auto; width: 90%; }
      .cover { flex: 0 0 300px; height: 300px; }
      .player { padding: 30px 20px; }
      
      .album-year-badge { top: 10px; left: 10px; } 
      
      .volume-container { right: 20px; bottom: 20px; }
      #winampVis { left: 20px; bottom: 20px; }
      
      .radio-title { font-size: 40px; }
      .listeners-badge { top: 10px; right: 10px; font-size: 12px; }
    }
  </style>
</head>
<body>

<!-- 1. Fondo Blur -->
<div class="background-blur visual-transition" id="bgBlur"></div>

<!-- 2. Pantalla de carga -->
<div class="splash-screen">
  <h1>Cargando...</h1>
  <div class="spinner"></div>
</div>

<!-- 3. Contador de Oyentes (Solo Icono y Número) -->
<div class="listeners-badge">
  <i class="fas fa-headphones"></i>
  <span id="listenerCount">--</span>
</div>

<!-- 4. TÍTULO -->
<h1 class="radio-title" data-text="Radiochar">Radiochar</h1>

<!-- 5. REPRODUCTOR -->
<div class="radio-container">
  
  <div class="cover">
    <!-- Año del álbum -->
    <div id="albumYear" class="album-year-badge visual-transition"></div>
    
    <!-- Imagen visual -->
    <img id="albumArt" class="visual-transition" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiSHNsDw3OZJEWNaqSm4hhstR9w8wF7TGzq_LMvnSt9ELIK_kIYyYLf_JHppvCkJNlMilGo0pKTh5XWas9cXEaR6f_GHQXi6qsn_ke6Zdpgv1imwbbkq_H9Uua9ZrdJ3hvKVlKQEf01qDxcwDEwdVFAtsXHknuMCgpno53zm2SHjgts2fhpC3MGPNU4BvJS/s16000/radiochar.online.png" alt="Album Art" />
  </div>

  <div class="player">
    
    <!-- CANVAS WINAMP -->
    <canvas id="winampVis" width="40" height="30"></canvas>

    <!-- FUENTE DE DATOS OCULTA -->
    <div id="data-source" style="display: none;">
        <div id="trackTitleSource" class="cc_streaminfo" data-type="tracktitle" data-username="robinson"></div>
        <div id="trackArtistSource" class="cc_streaminfo" data-type="trackartist" data-username="robinson"></div>
    </div>

    <!-- ELEMENTOS VISUALES -->
    <div class="song-title-container">
        <div id="displayTitle" class="song-title visual-transition">Conectando...</div>
    </div>
    
    <div id="displayArtist" class="artist-name visual-transition">Radiochar</div>
    
    <div class="controls">
      <button id="playPause"><i class="fas fa-play-circle"></i></button>
    </div>

    <!-- INDICADOR LIVE (Ahora debajo del botón) -->
    <div class="live-indicator">
      <div class="live-dot"></div>
      LIVE
    </div>

    <div class="volume-container">
      <i class="fas fa-volume-up"></i>
      <div class="volume-bar">
        <input type="range" id="volume" min="0" max="1" step="0.01" value="0.5" />
      </div>
    </div>
    
  </div>
</div>

<!-- 6. CRÉDITOS -->
<div class="creator-footer">
  Powered by <a href="https://www.robinsonchar.online/" target="_blank">robinsonchar</a>
</div>

<!-- 7. SCRIPTS -->
<audio id="radio" src="https://cast2.my-control-panel.com/proxy/robinson/stream" crossorigin="anonymous"></audio>
<script src="https://cast2.my-control-panel.com/system/streaminfo.js"></script>

<script>
  // --- REFERENCIAS ---
  const audio = document.getElementById('radio');
  const playPauseBtn = document.getElementById('playPause');
  const volume = document.getElementById('volume');
  const icon = playPauseBtn.querySelector('i');
  
  // Elementos OCULTOS
  const sourceTitle = document.getElementById('trackTitleSource');
  const sourceArtist = document.getElementById('trackArtistSource');

  // Elementos VISIBLES
  const displayTitle = document.getElementById('displayTitle');
  const displayArtist = document.getElementById('displayArtist');
  const albumArt = document.getElementById('albumArt');
  const bgBlur = document.getElementById('bgBlur');
  const listenerCountEl = document.getElementById('listenerCount');
  const albumYearEl = document.getElementById('albumYear');

  // URL DE IMAGEN POR DEFECTO
  const DEFAULT_COVER = 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiSHNsDw3OZJEWNaqSm4hhstR9w8wF7TGzq_LMvnSt9ELIK_kIYyYLf_JHppvCkJNlMilGo0pKTh5XWas9cXEaR6f_GHQXi6qsn_ke6Zdpgv1imwbbkq_H9Uua9ZrdJ3hvKVlKQEf01qDxcwDEwdVFAtsXHknuMCgpno53zm2SHjgts2fhpC3MGPNU4BvJS/s16000/radiochar.online.png';

  // --- GENERAR OYENTES ALEATORIOS (25 a 50) ---
  const randomListeners = Math.floor(Math.random() * (50 - 25 + 1) + 25);
  listenerCountEl.innerText = randomListeners;

  // --- AUDIO CONTEXT & WINAMP VISUALIZER ---
  let audioContext, analyser, source;
  let isAudioContextSetup = false;
  
  const BAR_COUNT = 4;
  let peakHeights = new Array(BAR_COUNT).fill(0); 
  const PEAK_DROP_SPEED = 0.5;
  const BLOCK_HEIGHT = 2;
  const BLOCK_GAP = 1;      
  const BLOCK_UNIT = BLOCK_HEIGHT + BLOCK_GAP; 

  function setupAudioContext() {
    if (isAudioContextSetup) return;
    try {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      audioContext = new AudioContext();
      analyser = audioContext.createAnalyser();
      source = audioContext.createMediaElementSource(audio);
      source.connect(analyser);
      analyser.connect(audioContext.destination);
      analyser.fftSize = 64; 
      isAudioContextSetup = true;
      animateWinamp();
    } catch (e) {
      console.warn("AudioContext Fallback");
      animateWinamp();
    }
  }

  const canvas = document.getElementById('winampVis');
  const ctx = canvas.getContext('2d');

  function getSegmentColor(y, height) {
    const percentage = 1 - (y / height);
    if (percentage > 0.85) return '#ff3333';
    if (percentage > 0.60) return '#ffaa00';
    return '#33ff33';
  }

  function animateWinamp() {
    requestAnimationFrame(animateWinamp);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let frequencyData = [];

    if (analyser && isPlaying && audioContext.state === 'running') {
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteFrequencyData(dataArray);
      
      const step = Math.floor(bufferLength / BAR_COUNT);
      for (let i = 0; i < BAR_COUNT; i++) {
        let sum = 0;
        let count = 0;
        for (let j = 0; j < step; j++) {
            const index = (i * step) + j;
            if(index < bufferLength) {
                sum += dataArray[index];
                count++;
            }
        }
        frequencyData.push(sum / count);
      }
    } else {
      if(isPlaying) {
         for(let i=0; i<BAR_COUNT; i++) frequencyData.push(Math.random() * 100);
      } else {
         frequencyData = [0,0,0,0];
      }
    }

    const barWidth = 8;
    const gap = 2;
    const totalW = (barWidth * BAR_COUNT) + (gap * (BAR_COUNT-1));
    const startX = (canvas.width - totalW) / 2;

    for (let i = 0; i < BAR_COUNT; i++) {
        const intensity = frequencyData[i] || 0;
        const targetHeight = (intensity / 255) * canvas.height;
        const x = startX + i * (barWidth + gap);

        const numBlocks = Math.floor(targetHeight / BLOCK_UNIT);
        for (let b = 0; b < numBlocks; b++) {
            const yBlock = canvas.height - (b * BLOCK_UNIT) - BLOCK_HEIGHT;
            ctx.fillStyle = getSegmentColor(yBlock, canvas.height);
            ctx.fillRect(x, yBlock, barWidth, BLOCK_HEIGHT);
        }

        if (targetHeight > peakHeights[i]) {
            peakHeights[i] = targetHeight;
        } else {
            peakHeights[i] -= PEAK_DROP_SPEED;
            if (peakHeights[i] < 0) peakHeights[i] = 0;
        }

        if (peakHeights[i] > BLOCK_UNIT) {
            const peakBlockIndex = Math.floor(peakHeights[i] / BLOCK_UNIT);
            const yPeak = canvas.height - (peakBlockIndex * BLOCK_UNIT) - BLOCK_HEIGHT;
            ctx.fillStyle = getSegmentColor(yPeak, canvas.height);
            ctx.fillRect(x, yPeak, barWidth, BLOCK_HEIGHT);
        }
    }
  }

  // --- LÓGICA REPRODUCTOR ---
  let isPlaying = false;
  audio.volume = 0.5;

  playPauseBtn.addEventListener('click', () => {
    if (!isAudioContextSetup) setupAudioContext();
    if (audioContext && audioContext.state === 'suspended') audioContext.resume();

    if (isPlaying) {
      audio.pause();
      icon.classList.remove('fa-stop-circle');
      icon.classList.add('fa-play-circle');
    } else {
      audio.play().catch(e => console.error(e));
      icon.classList.remove('fa-play-circle');
      icon.classList.add('fa-stop-circle');
    }
    isPlaying = !isPlaying;
  });

  volume.addEventListener('input', () => { audio.volume = volume.value; });

  function toTitleCase(str) {
    return str.toLowerCase().split(' ').map(function(word) {
      return word.charAt(0).toUpperCase() + word.slice(1);
    }).join(' ');
  }

  function checkMarquee() {
    const container = document.querySelector('.song-title-container');
    if (!displayTitle || !container) return;

    displayTitle.classList.remove('scrolling-text');
    displayTitle.style.removeProperty('--scroll-distance');

    if (displayTitle.scrollWidth > container.offsetWidth) {
      const distance = (displayTitle.scrollWidth - container.offsetWidth + 20) * -1;
      displayTitle.style.setProperty('--scroll-distance', `${distance}px`);
      displayTitle.classList.add('scrolling-text');
    }
  }

  // --- CONTROL DE ESTADO DE CANCIÓN ---
  let lastSongKey = ""; 

  async function updateInfo() {
    // 1. LEER DATOS DE LA FUENTE OCULTA
    let artist = sourceArtist.innerText.trim();
    let title = sourceTitle.innerText.trim();
    
    if (!artist || !title) return;

    const formattedArtist = toTitleCase(artist);
    const currentKey = `${formattedArtist}-${title}`;
    
    if (currentKey === lastSongKey) {
        checkMarquee();
        return;
    }
    
    lastSongKey = currentKey;

    // 2. BUSCAR NUEVA IMAGEN Y AÑO EN ITUNES
    const query = encodeURIComponent(`${artist} ${title}`);
    const url = `https://itunes.apple.com/search?term=${query}&media=music&limit=1`;
    let newCoverUrl = DEFAULT_COVER;
    let newYear = "";

    try {
      const res = await fetch(url);
      const data = await res.json();
      if (data.results.length > 0) {
        // Obtener portada HD
        newCoverUrl = data.results[0].artworkUrl100.replace('100x100bb', '600x600bb');
        
        // Obtener AÑO (releaseDate suele ser "YYYY-MM-DD...")
        if (data.results[0].releaseDate) {
            newYear = data.results[0].releaseDate.substring(0, 4);
        }
      }
    } catch (error) { /* Fallback */ }

    // 3. INICIAR TRANSICIÓN (FADE OUT)
    displayTitle.classList.add('fading-out');
    displayArtist.classList.add('fading-out');
    albumArt.classList.add('fading-out');
    bgBlur.classList.add('fading-out');
    albumYearEl.classList.add('fading-out');

    // 4. PRE-CARGAR Y ACTUALIZAR
    const imgLoader = new Image();
    imgLoader.src = newCoverUrl;
    
    setTimeout(() => {
        // A. ACTUALIZAR CONTENIDO
        displayTitle.innerText = title;
        displayArtist.innerText = formattedArtist;
        albumYearEl.innerText = newYear; 
        
        albumArt.src = newCoverUrl;
        bgBlur.style.backgroundImage = `url('${newCoverUrl}')`;

        // B. MARQUESINA
        checkMarquee();

        // C. FADE IN
        displayTitle.classList.remove('fading-out');
        displayArtist.classList.remove('fading-out');
        albumArt.classList.remove('fading-out');
        bgBlur.classList.remove('fading-out');
        albumYearEl.classList.remove('fading-out');

    }, 800); 
  }

  const observer = new MutationObserver(() => { setTimeout(updateInfo, 500); });
  if(sourceTitle) {
    observer.observe(sourceTitle, { childList: true, characterData: true, subtree: true });
  }
  
  setTimeout(updateInfo, 2000);
  window.addEventListener('resize', checkMarquee);

</script>

</body>
</html>
