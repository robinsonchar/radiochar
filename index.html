<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Radiochar - La emisora online número uno en Latam transmitiendo Hits de los 80s y 90s 24/7.">
  <meta name="theme-color" content="#0f0f0f">
  <title>RADIOCHAR</title>
  
  <!-- PRELOAD -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  
  <!-- ESTILOS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800;900&family=Russo+One&display=swap" rel="stylesheet">

  <style>
    /* 1. VARIABLES CSS */
    :root {
        --color-bg: #0f0f0f;
        --color-text-main: #ffffff;
        --color-text-muted: #aaaaaa;
        --color-accent-blue: #00c6ff;
        --color-accent-gold: #ffd700;
        --color-accent-pink: #ff00de;
        --color-accent-green: #39ff14;
        --color-accent-orange: #ff9900;
        --color-accent-red: #ff0000;
        
        --z-background: -1;
        --z-content: 5;
        --z-player-ui: 10;
        --z-chat: 9999;    
        --z-modal: 200;   
        --z-splash: 3000;  
    }

    /* 2. BASE */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--color-bg);
      color: var(--color-text-main);
      overflow-x: hidden;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      padding-bottom: 80px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* 3. OPTIMIZACIÓN GPU */
    .background-blur {
      position: fixed; top: -10%; left: -10%; width: 120%; height: 120%;
      z-index: var(--z-background);
      background-image: url('https://bit.ly/4q9Jddl');
      background-size: cover; background-position: center;
      filter: blur(50px) brightness(0.3);
      transform: translateZ(0); 
      will-change: opacity; 
      transition: background-image 1s ease-in-out;
      pointer-events: none;
    }

    .visual-transition { transition: opacity 0.8s ease-in-out; opacity: 1; }
    .fading-out { opacity: 0 !important; }

    /* 4. COMPONENTES UI */
    .radio-logo {
      display: block; max-width: 400px; width: 80%; height: auto;
      margin: 60px auto 40px auto; z-index: var(--z-content);
      padding: 0 10px; 
      filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.1)); 
    }

    .splash-screen {
      position: fixed; inset: 0;
      background: var(--color-bg);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: var(--z-splash);
      animation: fadeOut 1s 3s forwards; 
      pointer-events: none;
    }
    .spinner { border: 3px solid #333; border-top: 3px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

    /* Reproductor */
    .radio-container {
      display: flex;
      width: 1000px; max-width: 95%; height: 320px;
      background: rgba(30, 30, 30, 0.6);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      box-shadow: 0 30px 70px rgba(0, 0, 0, 0.5);
      overflow: hidden; position: relative;
      border: 1px solid rgba(255, 255, 255, 0.05);
      margin: 20px auto 50px auto; 
      flex-shrink: 0; z-index: var(--z-content);
    }

    .cover { flex: 0 0 320px; position: relative; overflow: hidden; }
    .cover img { width: 100%; height: 100%; object-fit: cover; display: block; transition: transform 0.5s ease; }
    .album-year-badge { position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.7); color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 10; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); }
    .wiki-btn { position: absolute; top: 15px; right: 15px; width: 32px; height: 32px; background: rgba(0, 0, 0, 0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: rgba(255, 255, 255, 0.9); text-decoration: none; transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.2); z-index: 20; backdrop-filter: blur(5px); cursor: pointer; }
    .wiki-btn:hover { background: rgba(255, 255, 255, 0.9); color: #000; transform: scale(1.1); border-color: #fff; }

    .player { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; padding: 30px 40px; position: relative; }
    #winampVis { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 0.1; }
    
    .info-wrapper { z-index: 5; text-align: left; margin-bottom: 25px; width: 100%; overflow: hidden; }
    .player-meta-row { display: flex; align-items: center; gap: 15px; margin-bottom: 8px; width: 100%; justify-content: flex-start; }
    .live-tag-inline { display: flex; align-items: center; gap: 6px; color: #fff; font-size: 11px; font-weight: 800; letter-spacing: 1px; flex-shrink: 0; }
    .live-dot-inline { width: 8px; height: 8px; border-radius: 50%; background-color: #ff0000; box-shadow: 0 0 8px rgba(255, 0, 0, 0.8); animation: blink 1.5s infinite; }
    .listener-tag-inline { display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 600; color: #888; flex-shrink: 0; }
    .listener-tag-inline i { font-size: 10px; color: #aaa; }
    
    .program-tag-inline {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        font-weight: 700;
        color: var(--color-accent-gold);
        text-transform: uppercase;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border-left: 1px solid rgba(255,255,255,0.2);
        padding-left: 15px;
        letter-spacing: 0.5px;
    }
    .program-tag-inline i { color: var(--color-accent-gold); font-size: 10px; }

    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .song-title-container { width: 100%; white-space: nowrap; overflow: hidden; }
    .song-title-container.is-scrolling { mask-image: linear-gradient(to right, black 90%, transparent 100%); -webkit-mask-image: linear-gradient(to right, black 90%, transparent 100%); }
    .song-title { font-size: 45px; font-weight: 700; color: #fff; display: inline-block; margin-bottom: 5px; padding-right: 20px; will-change: transform; }
    .artist-name { font-size: 18px; color: var(--color-text-muted); font-weight: 400; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .scrolling-text { animation: scroll-text 15s linear infinite alternate; }
    @keyframes scroll-text { 0%, 15% { transform: translateX(0); } 85%, 100% { transform: translateX(var(--scroll-distance)); } }

    .timeline-container { width: 100%; display: flex; align-items: center; gap: 15px; margin-bottom: 25px; z-index: 5; }
    .time-display { font-size: 12px; font-weight: 600; color: #ddd; font-variant-numeric: tabular-nums; min-width: 40px; }
    .progress-bar-bg { flex: 1; min-width: 0; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; position: relative; }
    .progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #00c6ff, #0072ff); border-radius: 3px; transition: width 1s linear; }

    .controls-row { display: flex; align-items: center; justify-content: center; z-index: 5; width: 100%; }
    .play-btn-wrapper { position: relative; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; }
    .play-btn { width: 60px; height: 60px; border-radius: 50%; background: #fff; border: none; color: #121212; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(255,255,255,0.3); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); padding-left: 4px; }
    .play-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(255,255,255,0.5); }
    .play-btn.playing { padding-left: 0; background: var(--color-accent-blue); color: #fff; }

    /* 5. SECCIONES */
    .content-section { width: 1000px; max-width: 95%; margin: 50px auto; z-index: var(--z-content); }
    .section-header-common { margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-end; }
    .section-title-common { font-size: 18px; text-transform: uppercase; letter-spacing: 2px; font-weight: 700; padding-left: 10px; margin: 0; }

    .slogan-section { text-align: center; margin-top: 70px; margin-bottom: 70px; }
    .slogan-text { font-family: 'Russo One', sans-serif; font-size: 60px; color: #fff; text-transform: uppercase; text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); letter-spacing: 2px; line-height: 1.1; margin-bottom: 10px; }
    .sub-slogan { font-family: 'Russo One', sans-serif; font-size: 30px; color: #fff; text-transform: uppercase; text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); letter-spacing: 2px; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 15px; }

    .card-grid-container { display: grid; gap: 20px; }
    
    .recent-tracks-title-custom { color: var(--color-accent-blue); border-left: 3px solid var(--color-accent-blue); }
    .dyk-title-custom { color: var(--color-accent-pink); border-left: 3px solid var(--color-accent-pink); }
    .schedule-title-custom { color: #fff; border-left: 3px solid #fff; }

    .recent-tracks-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    .hist-card { background: rgba(30, 30, 30, 0.4); border-radius: 10px; overflow: hidden; position: relative; transition: transform 0.3s ease; }
    .hist-card:hover { transform: translateY(-3px); }
    .hist-cover-wrap { position: relative; width: 100%; aspect-ratio: 1/1; }
    .hist-cover { width: 100%; height: 100%; object-fit: cover; }
    .hist-num { position: absolute; top: 8px; right: 8px; width: 26px; height: 26px; background: rgba(0,0,0,0.8); color: #fff; border-radius: 50%; font-size: 12px; font-weight: 700; display: flex; align-items: center; justify-content: center; border: 0px solid var(--color-accent-blue); z-index: 2; }
    .hist-info { padding: 10px; }
    .hist-title { font-size: 12px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
    .hist-artist { font-size: 11px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .hist-time { font-size: 10px; color: var(--color-accent-blue); margin-top: 4px; font-weight: 600; display: flex; align-items: center; gap: 4px; opacity: 0.9; }

    /* --- ESTILOS PROGRAMACIÓN (INFINITE SLIDER) --- */
    .schedule-container-custom {
        position: relative;
        width: 100%;
        overflow: hidden;
        padding: 40px 0;
    }

    .schedule-track {
        display: flex;
        gap: 0;
        padding-left: calc(50% - 150px);
        width: max-content;
    }

    .schedule-card-item {
        flex: 0 0 300px; 
        max-width: 300px;
        padding: 0 15px; 
        transition: opacity 0.5s ease, transform 0.5s ease, filter 0.5s ease;
        opacity: 0.4;
        transform: scale(0.9);
        filter: blur(2px);
    }

    .schedule-card-item.active-slide {
        opacity: 1;
        transform: scale(1.1);
        filter: blur(0);
        z-index: 10;
    }

    .program-card {
        position: relative;
        height: 180px;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    
    .schedule-card-item.active-slide.is-live .program-card {
        border: 2px solid var(--color-accent-red);
        box-shadow: 0 0 30px rgba(255,0,0,0.4);
    }

    .program-bg {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        object-fit: cover;
        z-index: 1;
    }

    .program-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.3));
        z-index: 2;
        padding: 15px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }

    .program-time {
        font-size: 13px;
        color: var(--color-accent-gold);
        font-weight: 700;
        margin-bottom: 5px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }

    .program-title {
        font-family: 'Russo One', sans-serif;
        font-size: 20px;
        color: #fff;
        line-height: 1.1;
        text-transform: uppercase;
    }

    .program-subtitle {
        font-size: 11px;
        color: var(--color-accent-blue);
        font-weight: 600;
        text-transform: uppercase;
        margin-top: 5px;
        letter-spacing: 1px;
    }

    .on-air-badge {
        position: absolute;
        top: 10px; right: 10px;
        background: var(--color-accent-red);
        color: #fff;
        font-size: 10px;
        font-weight: 800;
        padding: 4px 8px;
        border-radius: 4px;
        z-index: 10;
        animation: blink 1.5s infinite;
        display: none;
    }
    
    .schedule-card-item.is-live .on-air-badge { display: block; }

    /* Feature Card Styles (Sabías Que) */
    .feature-card { display: grid; grid-template-columns: 320px 1fr; gap: 30px; background: rgba(74, 74, 74, 0.1); border: none; border-radius: 16px; overflow: hidden; backdrop-filter: blur(10px); }
    .feature-image-wrapper { width: 100%; height: 320px; position: relative; overflow: hidden;}
    .feature-image { width: 100%; height: 100%; object-fit: cover; display: block; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: transform 0.5s ease; }
    .feature-card:hover .feature-image { transform: scale(1.05); }
    .feature-badge { position: absolute; top: 15px; left: 15px; color: #fff; font-weight: 700; font-size: 12px; padding: 4px 12px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.4); text-transform: uppercase; letter-spacing: 1px; z-index: 2; }
    .badge-pink { background: var(--color-accent-pink); border: 1px solid var(--color-accent-pink); }
    .badge-green { background: var(--color-accent-green); border: 1px solid var(--color-accent-green); color: #000; }
    .feature-content { padding: 10px 30px 10px 0; display: flex; flex-direction: column; justify-content: center; }
    .feature-headline { font-size: 28px; font-weight: 800; color: #fff; margin-bottom: 5px; line-height: 1.2; }
    .feature-subhead { font-size: 18px; color: var(--color-accent-blue); font-weight: 600; margin-bottom: 20px; }
    .feature-meta { display: flex; gap: 20px; margin-bottom: 25px; font-size: 13px; color: #aaa; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
    .feature-text { font-size: 15px; line-height: 1.7; color: #ddd; }

    /* FLECHAS DE NAVEGACIÓN COMUNES */
    .slider-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 40px;
        background: rgba(0,0,0,0.5);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 20;
        transition: all 0.3s ease;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .slider-arrow:hover { background: var(--color-accent-gold); color: #000; }
    .slider-arrow.left { left: -10px; }
    .slider-arrow.right { right: -10px; }
    .slider-arrow.disabled { opacity: 0.3; cursor: default; pointer-events: none; }
    
    /* Footer */
    .community-section { text-align: center; margin-top: 50px; margin-bottom: 50px; }
    .community-title { font-family: 'Russo One', sans-serif; font-size: 60px; color: #fff; text-transform: uppercase; text-shadow: 0 0 10px rgba(255, 255, 255, 0.1); margin-bottom: 25px; letter-spacing: 1px; line-height: 1.1; }
    .buttons-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
    .btn-social { display: inline-flex; align-items: center; justify-content: center; font-family: 'Poppins', sans-serif; font-size: 20px; font-weight: 700; padding: 15px 40px; border-radius: 50px; text-decoration: none; transition: all 0.3s ease; border: none; cursor: pointer; min-width: 250px; }
    .btn-facebook { background-color: #1877F2; color: #fff; box-shadow: 0 4px 15px rgba(24, 119, 242, 0.4); }
    .btn-facebook:hover { background-color: #1565C0; transform: translateY(-3px); box-shadow: 0 8px 25px rgba(24, 119, 242, 0.6); }
    .btn-x { background-color: #000; color: #fff; box-shadow: 0 4px 15px rgba(255, 255, 255, 0.15); }
    .btn-x:hover { background-color: #111; transform: translateY(-3px); box-shadow: 0 8px 25px rgba(255, 255, 255, 0.25); }
    .btn-social i { margin-right: 12px; font-size: 24px; }
    
    .creator-footer { 
        margin-top: 40px; 
        font-size: 12px; 
        color: rgba(255, 255, 255, 0.4); 
        text-align: center; 
        z-index: var(--z-content); 
        display: flex; 
        flex-direction: row; 
        justify-content: center; 
        align-items: center; 
        min-height: 40px; 
        gap: 5px; 
    }
    .creator-footer a { color: #fff; text-decoration: none; opacity: 0.7; }
    .creator-footer a:hover { opacity: 1; text-decoration: underline; }

    /* 6. OVERLAYS (CBOX RESPONSIVE FIX V7.7) */
    #cboxbutton { position: fixed; bottom: 20px; right: 20px; z-index: var(--z-chat) !important; border-radius: 50% !important; background-color: #1877F2 !important; border: 1px solid #1565C0 !important; color: #fff !important; width: 50px !important; height: 50px !important; padding: 0 !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 4px 10px rgba(0,0,0,0.3) !important; font-size: 20px !important; }
    #cboxwrap { position: fixed; bottom: 80px; right: 20px; z-index: var(--z-chat) !important; border-radius: 12px !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; background: rgba(255, 255, 255, 0.8) !important; backdrop-filter: blur(10px) !important; }
    
    /* DEFINICIÓN ESTRICTA DE TAMAÑO PARA CBOX */
    #cboxdiv {
        display: flex !important;
        flex-direction: column !important;
        width: 380px !important;
        height: 500px !important;
        overflow: hidden !important;
    }
    
    .cbox-frame-main {
        flex: 1 !important;
        width: 100% !important;
        border: 0 !important;
        min-height: 0 !important; /* Fix para Flexbox */
    }
    
    .cbox-frame-form {
        height: 155px !important;
        flex-shrink: 0 !important;
        width: 100% !important;
        border: 0 !important;
        border-top: 1px solid rgba(0,0,0,0.1) !important;
    }
    
    #cc_recenttracks_original { display: none !important; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); z-index: var(--z-modal); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.4s ease; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal-content { background: #1a1a1a; width: 700px; max-width: 95%; padding: 30px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5); transform: translateY(20px); transition: transform 0.4s ease; position: relative; }
    .modal-overlay.active .modal-content { transform: translateY(0); }
    .modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; opacity: 0.6; transition: opacity 0.3s; }
    .modal-close:hover { opacity: 1; }
    .modal-title { font-size: 22px; font-weight: 700; margin-bottom: 10px; color: #fff; }
    .modal-subtitle { font-size: 14px; color: var(--color-accent-blue); margin-bottom: 20px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    .modal-body { font-size: 14px; line-height: 1.6; color: #ccc; max-height: 300px; overflow-y: auto; padding-right: 10px; }
    .modal-meta { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 20px; font-size: 13px; color: #888; }
    .modal-meta span { display: block; color: #fff; font-weight: 500; margin-top: 3px; }

    /* 7. RESPONSIVE */
    @media (max-width: 800px) {
      .feature-image-wrapper { height: 250px; }
      .feature-content { padding: 20px; }
      .feature-card { grid-template-columns: 1fr; }
      .slogan-text, .community-title { font-size: 36px; } 
      .sub-slogan { font-size: 24px; }
      .buttons-container { flex-direction: column; align-items: center; }
      .btn-social { width: 100%; max-width: 300px; }
      .slider-arrow { background: rgba(0,0,0,0.8); }
      .slider-arrow.left { left: 0; }
      .slider-arrow.right { right: 0; }
      .schedule-track { padding-left: calc(50% - 135px); } 
      .schedule-card-item { flex: 0 0 270px; max-width: 270px; }
      .program-tag-inline { display: none; } 
    }

    @media (max-width: 600px) {
      .radio-container { flex-direction: column; height: auto; width: 90%; }
      .cover { flex: 0 0 300px; height: 300px; }
      .player { padding: 25px; align-items: center; text-align: center; }
      .info-wrapper { text-align: center; }
      .controls-row { justify-content: center; gap: 20px; }
      .player-meta-row { justify-content: center; } 
      .recent-tracks-grid { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); }
      .radio-container, .content-section, .slogan-section, .community-section { margin-bottom: 50px; } 
      .radio-logo { max-width: 300px; }
      
      /* Ajuste CBOX MÓVIL (SOBRESCRIBE ESCRITORIO) */
      #cboxdiv {
          width: 85vw !important; /* ~85% del ancho de pantalla */
          height: 60vh !important; /* Altura dinámica */
      }
      #cboxwrap {
          bottom: 75px !important;
          right: 10px !important;
      }
    }
  </style>
</head>
<body>

<!-- Fondo y Splash -->
<div class="background-blur visual-transition" id="bgBlur"></div>
<div class="splash-screen">
  <h1>Sintonizando...</h1>
  <div class="spinner"></div>
</div>

<!-- Modal Pop-up -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()" aria-label="Cerrar ventana"><i class="fas fa-times"></i></button>
    <div class="modal-title" id="modalArtist">Artista</div>
    <div class="modal-subtitle" id="modalTitle">Canción</div>
    <div class="modal-body" id="modalBio">Cargando información...</div>
    <div class="modal-meta">
        <div>Álbum<span id="modalAlbum">--</span></div>
        <div>Género<span id="modalGenre">--</span></div>
    </div>
  </div>
</div>

<!-- Header -->
<header>
    <img src="https://bit.ly/4rSMOON" alt="Radiochar Logo" class="radio-logo">
</header>

<!-- Main -->
<main>
    <!-- REPRODUCTOR -->
    <section class="radio-container" aria-label="Reproductor de Radio">
      <div class="cover">
        <button id="wikiBtn" class="wiki-btn" title="Ver reseña" onclick="openInfoModal()" aria-label="Más información"><i class="fas fa-info"></i></button>
        <div id="albumYear" class="album-year-badge visual-transition"></div>
        <img id="albumArt" class="visual-transition" src="https://bit.ly/4q9Jddl" alt="Portada del Álbum">
      </div>

      <div class="player">
        <canvas id="winampVis" aria-hidden="true"></canvas>
        <div class="info-wrapper">
          <div class="player-meta-row">
              <div class="live-tag-inline"><div class="live-dot-inline"></div> LIVE</div>
              <div class="listener-tag-inline"><i class="fas fa-headphones" aria-hidden="true"></i><span id="listenerCount">--</span></div>
              <div class="program-tag-inline"><i class="fas fa-broadcast-tower"></i> <span id="currentProgramDisplay">--</span></div>
          </div>
          <div class="song-title-container">
            <div id="displayTitle" class="song-title visual-transition">Conectando...</div>
          </div>
          <div id="displayArtist" class="artist-name visual-transition">Radiochar</div>
        </div>

        <div class="timeline-container">
          <div id="currentTime" class="time-display">00:00</div>
          <div class="progress-bar-bg"><div id="progressFill" class="progress-bar-fill"></div></div>
          <div id="totalTime" class="time-display">--:--</div>
        </div>

        <div class="controls-row">
          <div class="play-btn-wrapper">
            <button id="playPause" class="play-btn" aria-label="Reproducir o Pausar"><i class="fas fa-play"></i></button>
          </div>
        </div>
        
        <div id="data-source" style="display: none;" aria-hidden="true">
            <div id="trackTitleSource" class="cc_streaminfo" data-type="tracktitle" data-username="robinson"></div>
            <div id="trackArtistSource" class="cc_streaminfo" data-type="trackartist" data-username="robinson"></div>
        </div>
      </div>
    </section>

    <!-- PROGRAMACIÓN SEMANAL (INFINITE TIMELINE SLIDER) -->
    <section class="content-section schedule-section">
      <div class="section-header-common">
        <h2 class="section-title-common schedule-title-custom">PROGRAMACIÓN SEMANAL</h2>
      </div>
      
      <div class="schedule-container-custom" id="scheduleSlider">
         <div class="slider-arrow left" id="schedPrev"><i class="fas fa-chevron-left"></i></div>
         <div class="slider-arrow right" id="schedNext"><i class="fas fa-chevron-right"></i></div>
         
         <div class="schedule-track" id="scheduleTrack">
            <!-- Inyectado por JS -->
         </div>
      </div>
    </section>

    <!-- HISTORIAL -->
    <section class="content-section recent-tracks-container">
        <div class="section-header-common">
            <h2 class="section-title-common recent-tracks-title-custom">LAS ÚLTIMAS QUE SONARON</h2>
        </div>
        <div id="recentTracksGrid" class="recent-tracks-grid card-grid-container">
            <div class="no-tracks-msg">Cargando historial...</div>
        </div>
    </section>

    <!-- SLOGAN -->
    <section class="content-section slogan-section">
        <h2 class="slogan-text">LA EMISORA ONLINE <p style="color: yellow; display: inline;">#1</p> EN LATAM</h2>
        <h3 class="sub-slogan">TRANSMITIENDO 24/7 DESDE 2011 EN HD</h3>
    </section>

    <!-- SABÍAS QUE -->
    <section class="content-section did-you-know-container" id="didYouKnowContainer" style="display: none;">
        <div class="section-header-common">
             <h2 class="section-title-common dyk-title-custom">SABÍAS QUE...</h2>
        </div>
        <article id="dykContent" class="feature-card">
            <div class="feature-image-wrapper">
                <div class="feature-badge badge-pink">El Dato</div>
                <img src="" class="feature-image" id="dykCover" alt="Cover">
            </div>
            <div class="feature-content">
                <div class="feature-headline" id="dykTitle">Cargando...</div>
                <div class="feature-subhead" id="dykArtist"></div>
                <div class="feature-meta">
                    <div id="dykAlbum"><i class="fas fa-compact-disc"></i> <span>--</span></div>
                    <div id="dykYear"><i class="fas fa-calendar-alt"></i> <span>--</span></div>
                </div>
                <div class="feature-text" id="dykText">Buscando datos interesantes...</div>
            </div>
        </article>
    </section>

</main>

<!-- Footer -->
<footer class="community-section">
    <h2 class="community-title">ÚNETE A NUESTRA COMUNIDAD</h2>
    <div class="buttons-container">
        <a href="https://www.facebook.com/Radionlineco/" target="_blank" rel="noopener noreferrer" class="btn-social btn-facebook">
            <i class="fab fa-facebook-f" aria-hidden="true"></i> Síguenos en Facebook
        </a>
        <a href="https://x.com/radiocharonline" target="_blank" rel="noopener noreferrer" class="btn-social btn-x">
            <i class="fa-brands fa-x-twitter" aria-hidden="true"></i> Síguenos en X
        </a>
    </div>
    <div class="creator-footer">
      <span>Powered by</span> 
      <a href="https://www.robinsonchar.online/" target="_blank" rel="noopener noreferrer">robinsonchar</a>
    </div>
</footer>

<!-- CBOX -->
<div id="cboxbutton" aria-label="Abrir Chat"></div>
<div id="cboxwrap"></div>
<div id="cc_recenttracks_original" class="cc_recenttracks_list" data-username="robinson" aria-hidden="true"></div>

<audio id="radio" src="https://cast2.my-control-panel.com/proxy/robinson/stream"></audio>

<script>
window.onerror = function(message) { if (message.includes("Script error")) return true; };

const itunesCache = new Map();

const CONFIG = {
    DEFAULT_COVER: 'https://bit.ly/4q9Jddl',
    ENDPOINTS: {
        RECENT_FEED: 'https://cast2.my-control-panel.com/recentfeed/robinson/json/',
        ITUNES: 'https://itunes.apple.com/search',
        WIKI_SEARCH: 'https://es.wikipedia.org/w/api.php',
        WIKI_SUMMARY: 'https://es.wikipedia.org/api/rest_v1/page/summary/'
    },
    FILTERS: ['pisa', 'pisacanciones', 'jingle', 'promo', 'indicativo', 'sello', 'intro', 'podcast', 'comercial', 'cuña', 'radiochar'],
    REFRESH_RATE_MS: 90000 
};

const DOM = {
    audio: document.getElementById('radio'),
    playBtn: document.getElementById('playPause'),
    playIcon: document.querySelector('#playPause i'),
    sourceTitle: document.getElementById('trackTitleSource'),
    sourceArtist: document.getElementById('trackArtistSource'),
    displayTitle: document.getElementById('displayTitle'),
    displayArtist: document.getElementById('displayArtist'),
    albumArt: document.getElementById('albumArt'),
    bgBlur: document.getElementById('bgBlur'),
    albumYear: document.getElementById('albumYear'),
    currentTime: document.getElementById('currentTime'),
    totalTime: document.getElementById('totalTime'),
    progressFill: document.getElementById('progressFill'),
    modal: {
        overlay: document.getElementById('modalOverlay'),
        artist: document.getElementById('modalArtist'),
        title: document.getElementById('modalTitle'),
        bio: document.getElementById('modalBio'),
        album: document.getElementById('modalAlbum'),
        genre: document.getElementById('modalGenre')
    },
    canvas: document.getElementById('winampVis'),
    recentGrid: document.getElementById('recentTracksGrid'),
    dyk: {
        container: document.getElementById('didYouKnowContainer'),
        cover: document.getElementById('dykCover'),
        title: document.getElementById('dykTitle'),
        artist: document.getElementById('dykArtist'),
        album: document.getElementById('dykAlbum'),
        year: document.getElementById('dykYear'),
        text: document.getElementById('dykText')
    },
    schedule: {
        track: document.getElementById('scheduleTrack'),
        prev: document.getElementById('schedPrev'),
        next: document.getElementById('schedNext')
    }
};

const Utils = {
    debounce: (func, wait) => {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    },
    cleanText: (text) => {
        if (!text) return "";
        return text.replace(/^\d+\.?\s*-?/, "").replace(/\(.*\)/g, "").replace(/\[.*\]/g, "").replace(/ft\..*/i, "").replace(/feat\..*/i, "").replace(/remix/i, "").replace(/original mix/i, "").replace(/extended/i, "").replace(/radio edit/i, "").trim();
    },
    formatTime: (seconds) => {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
    },
    toTitleCase: (str) => {
        if(!str) return "";
        return str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    },
    smartLimitText: (text, maxWords) => {
        if (!text) return "";
        const words = text.trim().split(/\s+/);
        if (words.length <= maxWords) return text;
        const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
        let result = "";
        let currentWordCount = 0;
        for (let s of sentences) {
            const wc = s.trim().split(/\s+/).length;
            if (currentWordCount + wc <= maxWords + 5) {
                result += s;
                currentWordCount += wc;
            } else {
                if (result === "") return words.slice(0, maxWords).join(" ") + "...";
                break;
            }
        }
        return result.trim();
    },
    safeFetchJson: async (url) => {
        try {
            const res = await fetch(url);
            if (!res.ok) return null;
            const text = await res.text();
            return text ? JSON.parse(text) : null;
        } catch (e) {
            return null;
        }
    },
    getVintageDate: () => {
        const now = new Date();
        const day = now.getDay();
        const diff = now.getDate() - day; 
        const sunday = new Date(now.setDate(diff));
        const vintageYear = sunday.getFullYear() - 40;
        const vintageDate = new Date(sunday);
        vintageDate.setFullYear(vintageYear);
        return {
            display: sunday.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '/').slice(0, -4) + vintageYear,
            obj: vintageDate,
            month: vintageDate.getMonth(), 
            day: vintageDate.getDate()
        };
    }
};

(function () {
    const cboxContainer = document.getElementById("cboxwrap");
    const cboxToggleButton = document.getElementById("cboxbutton");
    const icons = { open: '<i class="fas fa-comment-dots"></i>', close: '<i class="fas fa-times"></i>' };
    let isVisible = false;
    let htmlInjected = false;
    const toggleCbox = (show) => {
        cboxContainer.style.display = show ? "block" : "none";
        if (cboxToggleButton) cboxToggleButton.innerHTML = show ? icons.close : icons.open;
        if (show && !htmlInjected) {
            // HTML LIMPIO Y RESPONSIVO PARA CBOX
            cboxContainer.innerHTML = `
            <div id="cboxdiv">
                <iframe src="https://www4.cbox.ws/box/?boxid=3774862&boxtag=a7lslt&sec=main" marginheight="0" marginwidth="0" frameborder="0" scrolling="auto" allowtransparency="yes" name="cboxmain4-3774862" id="cboxmain4-3774862" class="cbox-frame-main"></iframe>
                <iframe src="https://www4.cbox.ws/box/?boxid=3774862&boxtag=a7lslt&sec=form" allow="autoplay" marginheight="0" marginwidth="0" frameborder="0" scrolling="no" allowtransparency="yes" name="cboxform4-3774862" id="cboxform4-3774862" class="cbox-frame-form"></iframe>
            </div>`;
            htmlInjected = true;
        }
        isVisible = show;
    };
    if (cboxToggleButton) {
        cboxToggleButton.onclick = () => toggleCbox(!isVisible);
        toggleCbox(false);
    }
})();

// === SCHEDULE ENGINE (CLEAN & STATIC) ===
const ScheduleEngine = {
    programs: [
        { id: 'lover', title: 'LOVER CITY', subtitle: 'BALADAS AMERICANAS', start: 0, end: 6, img: 'https://mickpini.com/wp-content/uploads/2025/07/1.png', displayTime: '00:00 - 05:59 (GMT-5)' },
        { id: 'wonders', title: 'THE WONDERS', subtitle: 'LOS 90S', start: 6, end: 12, img: 'https://wallpapers.com/images/hd/90s-theme-background-fdllcnh7s97z4qio.jpg', displayTime: '06:00 - 11:59 (GMT-5)' },
        { id: 'tirando', title: 'TIRANDO PIEDRAS', subtitle: 'ROCK EN ESPAÑOL', start: 12, end: 15, img: 'https://dojiw2m9tvv09.cloudfront.net/36300/product/los-rodriguez-vinilo-89039.jpg', displayTime: '12:00 - 14:59 (GMT-5)' },
        { id: 'rockstars', title: 'ROCKSTARS', subtitle: 'ROCK DE LOS 80S', start: 15, end: 20, img: 'https://i0.wp.com/lashistoriasdelrock.com/wp-content/uploads/2024/06/Son-10-Canciones-de-Rock-Mas-Emblematicas-de-los-80s.jpg', displayTime: '15:00 - 19:59 (GMT-5)' },
        { id: 'hits_lie', title: 'HITS DON´T LIE', subtitle: 'HITS 80S/90S', start: 20, end: 24, img: 'https://djhire.melbourne/wp-content/uploads/2024/11/Bon-Jovi-80s.png', displayTime: '20:00 - 23:59 (GMT-5)' }
    ],

    init: function() {
        if(!DOM.schedule.track) return;
        const schedule = this.getTodaySchedule();
        new InfiniteTimelineSlider(DOM.schedule.track, DOM.schedule.prev, DOM.schedule.next, schedule);
        this.updatePlayerLabel(schedule);
        setInterval(() => this.updatePlayerLabel(schedule), 60000); 
    },

    getTodaySchedule: function() {
        // Return static list (No Trance, No Christmas)
        return JSON.parse(JSON.stringify(this.programs));
    },

    updatePlayerLabel: function(schedule) {
        const now = new Date().getHours();
        const activeProg = schedule.find(p => now >= p.start && now < p.end);
        if(activeProg) {
            document.getElementById('currentProgramDisplay').innerText = activeProg.title;
        }
    }
};

class InfiniteTimelineSlider {
    constructor(track, prevBtn, nextBtn, items) {
        this.track = track;
        this.prevBtn = prevBtn;
        this.nextBtn = nextBtn;
        this.originalItems = items;
        this.itemCount = items.length;
        
        const now = new Date().getHours();
        this.realIndex = items.findIndex(p => now >= p.start && now < p.end);
        if(this.realIndex === -1) this.realIndex = 0;
        
        this.render();
        this.initListeners();
    }

    render() {
        let html = '';
        this.originalItems.forEach((prog) => html += this.createCardHtml(prog, false));
        this.originalItems.forEach((prog) => html += this.createCardHtml(prog, true));
        this.originalItems.forEach((prog) => html += this.createCardHtml(prog, false));
        this.track.innerHTML = html;
        
        this.currentIndex = this.itemCount + this.realIndex;
        // Esperar a que el DOM pinte para calcular ancho
        setTimeout(() => {
            this.updateCardWidth();
            this.updatePosition(false);
        }, 50);
    }

    createCardHtml(prog, isReal) {
        return `
            <div class="schedule-card-item" data-id="${prog.id}" data-start="${prog.start}" data-end="${prog.end}">
                <div class="program-card">
                    <div class="on-air-badge">AL AIRE</div>
                    <img src="${prog.img}" class="program-bg" alt="${prog.title}" onerror="this.src='${CONFIG.DEFAULT_COVER}'">
                    <div class="program-overlay">
                        <div class="program-time">${prog.displayTime}</div>
                        <div class="program-title">${prog.title}</div>
                        <div class="program-subtitle">${prog.subtitle}</div>
                    </div>
                </div>
            </div>`;
    }

    initListeners() {
        this.prevBtn.addEventListener('click', () => this.slide(-1));
        this.nextBtn.addEventListener('click', () => this.slide(1));
        
        this.track.addEventListener('transitionend', () => {
            this.checkIndex();
        });
        
        window.addEventListener('resize', Utils.debounce(() => {
            this.updateCardWidth();
            this.updatePosition(false);
        }, 200));
    }
    
    updateCardWidth() {
        const firstCard = this.track.querySelector('.schedule-card-item');
        if(firstCard) {
            this.cardWidth = firstCard.offsetWidth; // Ancho dinámico real (incluye margin si lo hubiera en flex gap)
            // Como el gap es 0 y padding está en el item, offsetWidth es correcto.
            // Pero en CSS hay padding-left en track.
            // cardWidth es el desplazamiento.
        } else {
            this.cardWidth = 300;
        }
    }

    slide(dir) {
        this.track.style.transition = 'transform 0.5s cubic-bezier(0.25, 1, 0.5, 1)';
        this.currentIndex += dir;
        this.updatePosition(true);
    }

    updatePosition(animate) {
        const translateX = -(this.currentIndex * this.cardWidth);
        this.track.style.transform = `translateX(${translateX}px)`;
        this.updateVisuals();
    }

    checkIndex() {
        if (this.currentIndex >= this.itemCount * 2) {
            this.track.style.transition = 'none';
            this.currentIndex = this.itemCount; 
            this.updatePosition(false);
        } else if (this.currentIndex < this.itemCount) {
            this.track.style.transition = 'none';
            this.currentIndex = (this.itemCount * 2) - 1; 
            this.updatePosition(false);
        }
    }

    updateVisuals() {
        const cards = this.track.querySelectorAll('.schedule-card-item');
        const now = new Date().getHours();
        
        cards.forEach((card, idx) => {
            if (idx === this.currentIndex) {
                card.classList.add('active-slide');
                card.style.opacity = '1';
                card.style.transform = 'scale(1.1)';
                card.style.filter = 'blur(0)';
            } else {
                card.classList.remove('active-slide');
                card.style.opacity = '0.4';
                card.style.transform = 'scale(0.9)';
                card.style.filter = 'blur(2px)';
            }
            
            const start = parseInt(card.dataset.start);
            const end = parseInt(card.dataset.end);
            if (now >= start && now < end) {
                card.classList.add('is-live');
            } else {
                card.classList.remove('is-live');
            }
        });
    }
}

// PLAYER LOGIC
let isPlaying = false;
let currentMetadata = { artist: "Radiochar", song: "", album: "", genre: "" };
let timelineState = { duration: 0, current: 0, start: 0, interval: null };

document.getElementById('listenerCount').innerText = Math.floor(Math.random() * (50 - 25 + 1) + 25);

const ctx = DOM.canvas.getContext('2d');
const BARS = 30;
let frequencyData = new Array(BARS).fill(0);
let peakHeights = new Array(BARS).fill(0);

function animateWinamp() {
    requestAnimationFrame(animateWinamp);
    
    if (DOM.canvas.width !== DOM.canvas.clientWidth) {
        DOM.canvas.width = DOM.canvas.clientWidth;
        DOM.canvas.height = DOM.canvas.clientHeight;
    }
    
    ctx.clearRect(0, 0, DOM.canvas.width, DOM.canvas.height);
    
    if (isPlaying) {
        for(let i=0; i<BARS; i++) frequencyData[i] = Math.random() * 100;
    } else {
        frequencyData.fill(0);
    }

    const gap = 3;
    const barWidth = (DOM.canvas.width - (gap * (BARS - 1))) / BARS;
    ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';

    for (let i = 0; i < BARS; i++) {
        let intensity = frequencyData[i] || 0;
        const decay = 1 - (i * 0.05);
        let targetHeight = (intensity / 100) * DOM.canvas.height * decay;
        
        if (targetHeight > peakHeights[i]) peakHeights[i] = targetHeight; else peakHeights[i] -= 2;
        if (peakHeights[i] < 0) peakHeights[i] = 0;

        const h = peakHeights[i];
        const center = DOM.canvas.width / 2;
        const xOffset = (i * (barWidth + gap)) + (gap/2);
        
        ctx.fillRect(center - xOffset - barWidth, DOM.canvas.height - h, barWidth, h);
        ctx.fillRect(center + xOffset, DOM.canvas.height - h, barWidth, h);
    }
}
animateWinamp();

DOM.playBtn.addEventListener('click', () => {
    if (isPlaying) {
        DOM.audio.pause();
        DOM.playIcon.classList.replace('fa-pause', 'fa-play');
        DOM.playBtn.classList.remove('playing');
    } else {
        DOM.audio.play().catch(e => console.error("Error reproducción:", e));
        DOM.playIcon.classList.replace('fa-play', 'fa-pause');
        DOM.playBtn.classList.add('playing');
    }
    isPlaying = !isPlaying;
});

async function openInfoModal() {
    DOM.modal.overlay.classList.add('active');
    DOM.modal.artist.innerText = currentMetadata.artist;
    DOM.modal.title.innerText = currentMetadata.song;
    DOM.modal.album.innerText = currentMetadata.album || "Desconocido";
    DOM.modal.genre.innerText = currentMetadata.genre || "Varios";
    DOM.modal.bio.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando información...';
    const cleanTitle = Utils.cleanText(currentMetadata.song);
    const query = `${cleanTitle} ${currentMetadata.artist}`;
    const searchData = await Utils.safeFetchJson(`${CONFIG.ENDPOINTS.WIKI_SEARCH}?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*`);
    if (searchData && searchData.query?.search?.length > 0) {
        const pageTitle = searchData.query.search[0].title;
        const summaryData = await Utils.safeFetchJson(`${CONFIG.ENDPOINTS.WIKI_SUMMARY}${encodeURIComponent(pageTitle)}`);
        if (summaryData && summaryData.extract) { DOM.modal.bio.innerText = summaryData.extract; }
        else { DOM.modal.bio.innerText = "Reseña no disponible."; }
    } else { DOM.modal.bio.innerText = "No se encontró información en Wikipedia."; }
}

function closeModal() { DOM.modal.overlay.classList.remove('active'); }
DOM.modal.overlay.addEventListener('click', (e) => { if (e.target === DOM.modal.overlay) closeModal(); });

function initTimeline(key, durationMillis) {
    clearInterval(timelineState.interval);
    let adjustedDuration = durationMillis > 180000 ? durationMillis * 0.90 : durationMillis;
    const now = Date.now();
    let savedData = {};
    try { savedData = JSON.parse(localStorage.getItem('radioCurrentSong') || '{}'); } catch(e) {}
    if (savedData.key === key && savedData.startTime) { timelineState.start = savedData.startTime; }
    else { timelineState.start = now; try { localStorage.setItem('radioCurrentSong', JSON.stringify({ key: key, startTime: now })); } catch(e) {} }
    timelineState.duration = adjustedDuration / 1000;
    const updateTick = () => {
        const elapsed = (Date.now() - timelineState.start) / 1000;
        let current = elapsed > timelineState.duration ? timelineState.duration : elapsed;
        DOM.currentTime.innerText = Utils.formatTime(current);
        DOM.totalTime.innerText = Utils.formatTime(timelineState.duration);
        DOM.progressFill.style.width = `${(current / timelineState.duration) * 100}%`;
    };
    updateTick();
    timelineState.interval = setInterval(updateTick, 1000);
}

const checkMarquee = Utils.debounce(() => {
    const container = document.querySelector('.song-title-container');
    const title = DOM.displayTitle;
    title.classList.remove('scrolling-text');
    container.classList.remove('is-scrolling');
    title.style.removeProperty('--scroll-distance');
    if (title.scrollWidth > container.offsetWidth) {
        const distance = (title.scrollWidth - container.offsetWidth + 20) * -1;
        title.style.setProperty('--scroll-distance', `${distance}px`);
        title.classList.add('scrolling-text');
        container.classList.add('is-scrolling');
    }
}, 200);

window.addEventListener('resize', checkMarquee);

let lastSongKey = "";

async function updateInfo() {
    if (!DOM.sourceArtist || !DOM.sourceTitle) return;
    let artist = DOM.sourceArtist.innerText.trim();
    let title = DOM.sourceTitle.innerText.trim();
    if (!artist || !title) return;
    const formattedArtist = Utils.toTitleCase(artist);
    const uniqueKey = `${formattedArtist}-${title}`;
    currentMetadata.artist = formattedArtist;
    currentMetadata.song = title;
    if (uniqueKey === lastSongKey) { checkMarquee(); return; }
    
    // JINGLE FILTER
    const fullStr = (artist + " " + title).toLowerCase();
    if (CONFIG.FILTERS.some(f => fullStr.includes(f))) {
        return; // Stop update
    }

    // 1. FADE OUT
    const elementsToFade = [DOM.displayTitle, DOM.displayArtist, DOM.albumArt, DOM.bgBlur, DOM.albumYear];
    elementsToFade.forEach(el => el.classList.add('fading-out'));

    lastSongKey = uniqueKey;

    const cleanTitle = Utils.cleanText(title);
    let newCoverUrl = CONFIG.DEFAULT_COVER;
    let durationMillis = Math.floor(Math.random() * (260000 - 180000 + 1) + 180000); 

    const query = encodeURIComponent(artist + ' ' + cleanTitle);
    const term = artist + ' ' + cleanTitle;

    // Fetch logic...
    if (itunesCache.has(term)) {
        const cachedData = itunesCache.get(term);
        newCoverUrl = cachedData.url;
        if(cachedData.meta) {
            currentMetadata.album = cachedData.meta.album;
            currentMetadata.genre = cachedData.meta.genre;
            if(cachedData.meta.year) DOM.albumYear.innerText = cachedData.meta.year;
            if(cachedData.meta.duration) durationMillis = cachedData.meta.duration;
        }
        finishUpdateProcess();
    } else {
        const data = await Utils.safeFetchJson(`${CONFIG.ENDPOINTS.ITUNES}?term=${query}&media=music&limit=1`);
        let meta = {};
        if (data && data.results && data.results.length > 0) {
            const track = data.results[0];
            newCoverUrl = track.artworkUrl100.replace('100x100bb', '600x600bb');
            meta = {
                album: track.collectionName,
                genre: track.primaryGenreName,
                duration: track.trackTimeMillis,
                year: track.releaseDate ? track.releaseDate.substring(0, 4) : ""
            };
            currentMetadata.album = meta.album;
            currentMetadata.genre = meta.genre;
            if (meta.duration) durationMillis = meta.duration;
            if (meta.year) DOM.albumYear.innerText = meta.year;
        }
        itunesCache.set(term, { url: newCoverUrl, meta: meta });
        finishUpdateProcess();
    }

    function finishUpdateProcess() {
        // 2. Wait for Fade Out (e.g. 600ms)
        setTimeout(() => {
            // 3. Swap Content (Invisible)
            DOM.displayTitle.innerText = title;
            DOM.displayArtist.innerText = formattedArtist;
            
            const imgLoader = new Image();
            
            const showNewContent = () => {
                 DOM.albumArt.src = newCoverUrl;
                 DOM.bgBlur.style.backgroundImage = `url('${newCoverUrl}')`;
                 
                 initTimeline(uniqueKey, durationMillis);
                 checkMarquee();
                 
                 // 4. Fade In
                 setTimeout(() => {
                    elementsToFade.forEach(el => el.classList.remove('fading-out'));
                 }, 50); 
                 
                 loadRecentTracks();
            };

            imgLoader.onload = showNewContent;
            imgLoader.onerror = () => { 
                newCoverUrl = CONFIG.DEFAULT_COVER; 
                showNewContent(); 
            };
            imgLoader.src = newCoverUrl;

        }, 600); 
    }
}

const observer = new MutationObserver(function(mutations) {
    if(mutations.some(m => m.type === 'characterData' || m.type === 'childList')) {
        if(DOM.sourceTitle && DOM.sourceTitle.innerText.trim() !== "") { Utils.debounce(updateInfo, 500)(); }
    }
});

if(DOM.sourceTitle) observer.observe(DOM.sourceTitle, { childList: true, characterData: true, subtree: true });
setTimeout(updateInfo, 2000);

let lastDykId = "";

async function loadRecentTracks() {
    if (!DOM.recentGrid) return;
    let items = [];
    const data = await Utils.safeFetchJson(`${CONFIG.ENDPOINTS.RECENT_FEED}?_=${Date.now()}`);
    if (data && data.items) { items = data.items; }
    if (items.length > 0) { renderHistory(items); processDidYouKnow(items); }
}

function renderHistory(items) {
    let html = '';
    let count = 0;
    
    // AUTO-SYNC LOGIC (V6.5)
    let serverOffset = 0;
    if (items.length > 0 && (items[0].time || items[0].timestamp)) {
        const firstTimeRaw = items[0].time || items[0].timestamp;
        let firstTime = parseInt(firstTimeRaw);
        if (firstTime < 10000000000) firstTime *= 1000;
        const diff = Date.now() - firstTime;
        if (Math.abs(diff) > 3600000) { 
            serverOffset = diff; 
        }
    }

    // HEURÍSTICA DE TIEMPO
    let minutesAgo = 3; 

    for (const item of items) {
        if (count >= 5) break;
        let rawArtist = item.artist || "";
        let rawTitle = item.title || "";
        if (!rawArtist && rawTitle.includes('-')) { [rawArtist, rawTitle] = rawTitle.split('-').map(s => s.trim()); }
        const fullStr = (rawArtist + rawTitle).toLowerCase();
        if (CONFIG.FILTERS.some(f => fullStr.includes(f))) continue;
        if (Utils.cleanText(rawTitle).toLowerCase() === Utils.cleanText(currentMetadata.song).toLowerCase()) continue;
        const cleanArtist = Utils.cleanText(rawArtist) || "Radiochar";
        const cleanTitle = Utils.cleanText(rawTitle);
        
        let timeHtml = `<div class="hist-time"><i class="far fa-clock"></i> Hace ${minutesAgo} min</div>`;
        // Incremento aleatorio entre 3 y 5 minutos
        minutesAgo += Math.floor(Math.random() * (5 - 3 + 1) + 3);
        
        html += `<div class="hist-card" data-artist="${cleanArtist}" data-title="${cleanTitle}"><div class="hist-cover-wrap"><div class="hist-num">${count + 1}</div><img src="${item.image || CONFIG.DEFAULT_COVER}" alt="Cover" class="hist-cover lazy-cover" onerror="this.src='${CONFIG.DEFAULT_COVER}'"></div><div class="hist-info"><div class="hist-title" title="${cleanTitle}">${cleanTitle}</div><div class="hist-artist" title="${cleanArtist}">${cleanArtist}</div>${timeHtml}</div></div>`;
        count++;
    }
    if (DOM.recentGrid.innerHTML !== html) { DOM.recentGrid.innerHTML = html; fetchCoversBatch(); }
}

function fetchCoversBatch() {
    const cards = document.querySelectorAll('.hist-card');
    cards.forEach((card, idx) => {
        setTimeout(async () => {
            const img = card.querySelector('.hist-cover');
            if (!img || img.dataset.loaded) return;
            const term = card.dataset.artist + ' ' + card.dataset.title;
            if (itunesCache.has(term)) {
                const cached = itunesCache.get(term);
                img.src = cached.url; 
                img.dataset.loaded = "true";
                return;
            }
            const data = await Utils.safeFetchJson(`${CONFIG.ENDPOINTS.ITUNES}?term=${encodeURIComponent(term)}&media=music&limit=1`);
            if (data && data.results && data.results.length > 0) {
                const url = data.results[0].artworkUrl100.replace('100x100bb', '300x300bb');
                itunesCache.set(term, { url: url, meta: null }); 
                img.src = url;
            } else { itunesCache.set(term, { url: CONFIG.DEFAULT_COVER, meta: null }); }
            img.dataset.loaded = "true";
        }, idx * 150);
    });
}

async function processDidYouKnow(items) {
    const valid = items.filter(i => {
        const txt = ((i.artist||"") + (i.title||"")).toLowerCase();
        return !CONFIG.FILTERS.some(f => txt.includes(f));
    });
    if (valid.length === 0) return;
    const target = valid[Math.min(valid.length - 1, 9)];
    const id = target.artist + target.title;
    if (id !== lastDykId) {
        lastDykId = id;
        DOM.dyk.container.style.display = 'block';
        DOM.dyk.title.innerText = target.title;
        DOM.dyk.artist.innerText = target.artist || ""; 
        const cleanTitle = Utils.cleanText(target.title);
        const query = (target.artist || "") + " " + cleanTitle;
        const [itunesRes, wikiRes] = await Promise.allSettled([
            Utils.safeFetchJson(`${CONFIG.ENDPOINTS.ITUNES}?term=${encodeURIComponent(query)}&media=music&limit=1`),
            Utils.safeFetchJson(`${CONFIG.ENDPOINTS.WIKI_SEARCH}?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*`)
        ]);
        if (itunesRes.status === 'fulfilled' && itunesRes.value && itunesRes.value.results?.length > 0) {
            const t = itunesRes.value.results[0];
            DOM.dyk.cover.src = t.artworkUrl100.replace('100x100bb', '600x600bb');
            DOM.dyk.album.querySelector('span').innerText = t.collectionName || "--";
            DOM.dyk.year.querySelector('span').innerText = t.releaseDate ? t.releaseDate.substring(0,4) : "--";
        } else { DOM.dyk.cover.src = CONFIG.DEFAULT_COVER; }
        if (wikiRes.status === 'fulfilled' && wikiRes.value && wikiRes.value.query?.search?.length > 0) {
            const title = wikiRes.value.query.search[0].title;
            const summaryData = await Utils.safeFetchJson(`${CONFIG.ENDPOINTS.WIKI_SUMMARY}${encodeURIComponent(title)}`);
            if(summaryData) { DOM.dyk.text.innerText = Utils.smartLimitText(summaryData.extract, 50); }
        } else { DOM.dyk.text.innerText = "Un clásico de nuestra programación habitual en Radiochar."; }
    }
}

setInterval(loadRecentTracks, CONFIG.REFRESH_RATE_MS);
loadRecentTracks();

ScheduleEngine.init();

</script>
<script src="https://cast2.my-control-panel.com/system/streaminfo.js"></script>
<script src="https://cast2.my-control-panel.com/system/recenttracks.js"></script>
</body>
</html>
